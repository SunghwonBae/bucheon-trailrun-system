<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background: #f4f6f9; margin: 0; padding: 10px; text-align: center; }
        
        /* ìƒë‹¨ íƒ€ì´ë¨¸ ì„¹ì…˜ */
        .timer-box { background: #2c3e50; color: #fff; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        #timerDisplay { font-size: 3rem; font-weight: bold; font-variant-numeric: tabular-nums; }
        .info-text { font-size: 0.9rem; color: #bdc3c7; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ í†µì¼ */
        #startBtn, #resetBtn, #goAdminBtn, #finishBtn, #playerBtn { 
            color: white; border: none; padding: 10px 20px; border-radius: 5px; 
            cursor: pointer; font-size: 1rem; margin: 5px; font-weight: bold;
        }
        #startBtn { background: #e74c3c; }
        #playerBtn { background: #27ae60; }
        #resetBtn { background: #95a5a6; }
        #goAdminBtn { background: #34495e; }
        #finishBtn { background: #8e44ad; }

        /* ì…ë ¥ ì„¹ì…˜ */
        .input-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input { font-size: 2rem; width: 150px; text-align: center; padding: 10px; border: 2px solid #3498db; border-radius: 8px; }

        /* ìˆœìœ„í‘œ ë ˆì´ì•„ì›ƒ */
        .rank-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .rank-card { flex: 1; min-width: 300px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .rank-header { padding: 10px; color: white; font-weight: bold; }
        
        .senior-header { background: #2980b9; } /* ì¥ë…„ë¶€ íŒŒë‘ */
        .junior-header { background: #27ae60; } /* ì²­ë…„ë¶€ ì´ˆë¡ */
        .female-header { background: #8e44ad; } /* ì—¬ìë¶€ ë³´ë¼ */

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: center; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        th { background: #f8f9fa; color: #555; font-size: 0.8rem; }
        
        /* 1,2,3ìœ„ ê°•ì¡° */
        tr:nth-child(1) td { font-weight: bold; color: #d35400; } 
    </style>
</head>
<body>
    <h1 id="raceTitle">ğŸƒ ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ</h1>
    <div class="timer-box">
        <div class="info-text">ê²½ê³¼ ì‹œê°„</div>
        <div id="timerDisplay">READY</div>
        <div id="startTimeInfo" class="info-text">[ì„ ìˆ˜ë“¤ì€ GPXë™ì˜ë¥¼ í•´ì£¼ì‹œê³  ê´€ë¦¬ìëŠ” ê´€ë¦¬ìì„¤ì • ë²„íŠ¼ìœ¼ë¡œ ë¡œê·¸ì¸ë¶€íƒë“œë¦½ë‹ˆë‹¤.]</div>
        
        <div style="margin-top: 15px;">
            <button id="playerBtn" onclick="location.href='/player.html'">ğŸ“± ì„ ìˆ˜GPXë™ì˜</button>
            <button id="startBtn" onclick="startRace()">ğŸ”« ëŒ€íšŒ ì¶œë°œ</button>
            <button id="resetBtn" onclick="resetRace()">ğŸ”„ ì „ì²´ ì´ˆê¸°í™”</button>
            <button id="goAdminBtn" onclick="goToAdmin()">âš™ï¸ ê´€ë¦¬ì ì„¤ì •</button>
            <button id="finishBtn" onclick="finishRace()">ğŸ ëŒ€íšŒ ì¢…ë£Œ</button>
        </div>
    </div>

    <div class="input-box" style="margin-top:10px; background:#edf2f7;">
        <strong>ğŸ“¡ GPXì¸ì‹ ìë™ê³¨ì¸ ë°˜ê²½: </strong>
        <span id="currentRadiusInfo" style="font-weight:bold; color:#2c3e50;">20m</span>
    </div>

    <div id="finishBibInput" class="input-box" style="display: none;">
        <h3>ğŸ ì™„ì£¼ë°°ë²ˆ ì…ë ¥í›„ Enter</h3>
        <input type="number" id="bibInput" inputmode="numeric" placeholder="000">
    </div>

    <div class="container">
        <div id="missingSection" class="rank-card" style="display: none; width: 100%; border: 2px solid #e74c3c; margin-bottom: 20px;">
            <div class="rank-header" style="background: #e74c3c;">âš ï¸ ë¯¸ê³¨ì¸ì í˜„í™© (ì”ì—¬ <span id="missingCount">0</span>ëª…)</div>
            <table>
                <thead><tr><th> </th><th>ë°°ë²ˆ</th><th>ì´ë¦„</th><th>ì†Œì†</th><th>ì—°ë½ì²˜</th></tr></thead>
                <tbody id="missingList"></tbody>
            </table>
        </div>

        <div class="rank-container">
            <div class="rank-card">
                <div class="rank-header senior-header">ğŸƒâ€â™‚ï¸ ë‚¨ì ì¥ë…„ë¶€ (~78ë…„)</div>
                <table><tbody id="seniorList"></tbody></table>
            </div>
            <div class="rank-card">
                <div class="rank-header junior-header">ğŸƒâ€â™‚ï¸ ë‚¨ì ì²­ë…„ë¶€ (79ë…„~)</div>
                <table><tbody id="juniorList"></tbody></table>
            </div>
            <div class="rank-card">
                <div class="rank-header female-header">ğŸƒâ€â™€ï¸ ì—¬ì í†µí•©</div>
                <table><tbody id="femaleList"></tbody></table>
            </div>
        </div>

        <div class="rank-card" style="margin-top: 20px; width: 100%;">
            <div class="rank-header" style="background: #34495e;">ğŸ ì „ì²´ ì™„ì£¼ì ê¸°ë¡ (ìµœì‹ ìˆœ)</div>
            <table>
                <thead>
                    <tr>
                        <th>ìˆœìœ„</th>
                        <th>ë°°ë²ˆ</th>
                        <th>ì´ë¦„</th>
                        <th>ê³µì‹ ê¸°ë¡ (ì‹¬íŒ)</th>
                        <th>ìë™ ê¸°ë¡ (GPX)</th>
                    </tr>
                </thead>
                <tbody id="allFinishedList"></tbody>
            </table>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // [ìë™ ì„¤ì •] í˜„ì¬ ì—°ë„ ì ìš©
        const currentYear = new Date().getFullYear();
        document.title = `${currentYear} ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ`;
        document.getElementById('raceTitle').innerText = `ğŸƒ ${currentYear} ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ`;

        // [ë³´ì•ˆ] ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ (ì„œë²„ì—ì„œ ìˆ˜ì‹ )
        let adminPassword = "LOADING"; 
        socket.on('receive_password', (pw) => {
            adminPassword = pw;
        });

        // [UI] ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (ë¡œê·¸ì¸ í›„ finishBibInput í‘œì‹œ)
        if (localStorage.getItem('admin_access') === 'granted') {
            document.getElementById('finishBibInput').style.display = 'block';
        }

        let raceStartTime = null;
        let timerInterval = null;

        // 1. ëŒ€íšŒ ì¶œë°œ
        function startRace() {
            const password = prompt("ëŒ€íšŒ ì¶œë°œì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì´ë¯¸í•œë²ˆ ì¶œë°œí–ˆìœ¼ë©´ ê´€ë¦¬ìí˜ì´ì§€ì— ê¸°ë¡ì´ˆê¸°í™”í›„ ë‹¤ì‹œ ì¶œë°œí•´ì£¼ì„¸ìš”.");
            if (password === adminPassword) {
                socket.emit('start_race');
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            }
        }

        // ê´€ë¦¬ì í˜ì´ì§€ ì´ë™ ì‹œ ë¹„ë²ˆ í™•ì¸ ë° í† í° ë¶€ì—¬
        function goToAdmin() {
            const password = prompt("ê´€ë¦¬ì í˜ì´ì§€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if (password === adminPassword) {
                // ê°„ë‹¨í•œ ì„¸ì…˜ í† í° ì—­í• ì„ í•  ê°’ì„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                localStorage.setItem('admin_access', 'granted');
                location.href = '/admin.html';
            } else {
                alert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
            }
        }

        // ëŒ€íšŒ ì¢…ë£Œ
        function finishRace() {
            const password = prompt("ëŒ€íšŒ ì¢…ë£Œë¥¼ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if (password === adminPassword) {
                if (timerInterval) clearInterval(timerInterval);
                document.querySelector('.timer-box .info-text').innerText = "ëŒ€íšŒê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
                socket.emit('finish_race'); // ì„œë²„ì— ë¯¸ì™„ì£¼ì ì¼ê´„ ì²˜ë¦¬ ìš”ì²­
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            }
        }

        // ë¦¬ì…‹ í•¨ìˆ˜
        function resetRace() {
            if(confirm("âš ï¸ ê²½ê³ : ëª¨ë“  ì„ ìˆ˜ì˜ ì¶œë°œ ë° ë„ì°© ê¸°ë¡ì´ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const password = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
                if(password === adminPassword) { // ê°„ë‹¨í•œ ë³´ì•ˆ ì¥ì¹˜
                    socket.emit('reset_race');
                } else {
                    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                }
            }
        }

        socket.on('current_settings', (data) => {
            if(data.goalRadius) document.getElementById('currentRadiusInfo').innerText = `${data.goalRadius}m`;
        });

        socket.on('radius_changed', (val) => {
            document.getElementById('currentRadiusInfo').innerText = `${val}m`;
        });

        // ì„œë²„ë¡œë¶€í„° ë¦¬ì…‹ ì™„ë£Œ ì‹ í˜¸ë¥¼ ë°›ìœ¼ë©´ í™”ë©´ ìƒˆë¡œê³ ì¹¨
        socket.on('race_reset_complete', () => {
            alert("ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload(); // í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”
        });

        // 2. íƒ€ì´ë¨¸ ì‘ë™ ë¡œì§
        socket.on('race_status', (data) => {
            if (data.isStarted) {
                raceStartTime = new Date(data.startTime);
                
                // 1. ë²„íŠ¼ ë¹„í™œì„±í™” ë° ìŠ¤íƒ€ì¼ ë³€ê²½
                const btn = document.getElementById('startBtn');
                btn.disabled = true; // í´ë¦­ ë¶ˆê°€
                btn.style.display = 'none'; // ë˜ëŠ” ì•„ì˜ˆ ìˆ¨ê¹€
                btn.innerText = "ëŒ€íšŒ ì§„í–‰ ì¤‘";
                
                // 2. íƒ€ì´ë¨¸ ë ˆì´ë¸” ë³€ê²½
                document.getElementById('startTimeInfo').innerText = "ì¶œë°œ ì‹œê°: " + raceStartTime.toLocaleTimeString();
                
                // 3. íƒ€ì´ë¨¸ ê°€ë™
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(updateTimer, 1000);
            }
        });

        function updateTimer() {
            if (!raceStartTime) return;
            const now = new Date();
            const diff = now - raceStartTime;
            
            const h = Math.floor(diff / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('timerDisplay').innerText = 
                `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        // 3. ë°°ë²ˆ ì…ë ¥ ì „ì†¡
        const bibInput = document.getElementById('bibInput');
        bibInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && bibInput.value) {
                socket.emit('runner_arrived', bibInput.value);
                bibInput.value = '';
            }
        });

        socket.on('error_msg', (msg) => alert(msg));
        
        socket.on('update_ui', (data) => {
            // 1. ë¯¸ê³¨ì¸ì ì²˜ë¦¬ (20ëª… ë¯¸ë§Œ ì‹œ ë…¸ì¶œ)
            const count = data.notFinished.length;
            const missingSection = document.getElementById('missingSection');
            if (count > 0 && count < 20) {
                missingSection.style.display = 'block';
                document.getElementById('missingCount').innerText = count;
                renderMissingTable('missingList', data.notFinished);
            } else {
                missingSection.style.display = 'none';
            }

            // 2. ë¶€ë¬¸ë³„ ì…ìƒì ì²˜ë¦¬
            renderRankTable('seniorList', data.maleSenior);
            renderRankTable('juniorList', data.maleJunior);
            renderRankTable('femaleList', data.female);

            // 3. ì „ì²´ ê³¨ì¸ì ì²˜ë¦¬
            renderAllFinishedTable('allFinishedList', data.allFinished);
        });

        function renderRankTable(elementId, runners) {
            const tbody = document.getElementById(elementId);
            tbody.innerHTML = '';
            runners.forEach((r, index) => {
                // ê²½ê³¼ ì‹œê°„ ê³„ì‚°
                const record = new Date(new Date(r.finishTime) - new Date(r.startTime));
                const recordStr = record.toISOString().substr(11, 8); // HH:MM:SS í˜•ì‹

                const row = `<tr>
                    <td>${index + 1}</td>
                    <td>${r.bibNumber}</td>
                    <td>${r.name || '-'}</td>
                    <td>${recordStr}</td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        function renderAllFinishedTable(elementId, runners) {
            const tbody = document.getElementById(elementId);
            tbody.innerHTML = '';
            runners.forEach((r, index) => {
                // ê³µì‹ ê¸°ë¡ ê³„ì‚°
                const manualRecord = r.finishTime ? 
                    new Date(new Date(r.finishTime) - new Date(r.startTime)).toISOString().substr(11, 8) : "-";
                
                // ìë™ ê¸°ë¡ ê³„ì‚°
                const autoRecord = r.autoFinishTime ? 
                    new Date(new Date(r.autoFinishTime) - new Date(r.startTime)).toISOString().substr(11, 8) : "-";

                const row = `<tr>
                    <td>${index + 1}</td>
                    <td>${r.bibNumber}</td>
                    <td>${r.name}</td>
                    <td style="font-weight:bold; color:#2c3e50;">${manualRecord}</td>
                    <td style="color:#7f8c8d; font-size:0.85rem;">${autoRecord}</td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        function renderMissingTable(elementId, runners) {
            const tbody = document.getElementById(elementId);
            tbody.innerHTML = '';
            runners.forEach((r, index) => {
                const row = `<tr>
                    <td>${index + 1}</td>
                    <td>${r.bibNumber}</td>
                    <td>${r.name}</td>
                    <td>${r.affiliation}</td>
                    <td>${r.phone}</td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }
    </script>
</body>
</html>