<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background: #f4f6f9; margin: 0; padding: 10px; text-align: center; }
        
        /* ìƒë‹¨ íƒ€ì´ë¨¸ ì„¹ì…˜ */
        .timer-box { 
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: #fff; 
            padding: 30px; 
            border-radius: 20px; 
            margin-bottom: 25px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        #timerDisplay { font-size: 5rem; font-weight: 900; font-variant-numeric: tabular-nums; text-shadow: 0 4px 6px rgba(0,0,0,0.2); margin: 10px 0; line-height: 1.1; }
        .info-text { font-size: 1.1rem; color: #ecf0f1; font-weight: 500; opacity: 0.9; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ í†µì¼ */
        #startBtn, #resetBtn, #goAdminBtn, #finishBtn, #playerBtn, #logoutBtn { 
            color: white; border: none; padding: 10px 20px; border-radius: 5px; 
            cursor: pointer; font-size: 1rem; margin: 5px; font-weight: bold;
        }
        #startBtn { background: #e74c3c; }
        #playerBtn { background: #27ae60; }
        #resetBtn { background: #95a5a6; }
        #goAdminBtn { background: #34495e; }
        #logoutBtn { background: #7f8c8d; }
        #finishBtn { background: #8e44ad; }

        /* ì…ë ¥ ì„¹ì…˜ */
        .input-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input { font-size: 2rem; width: 150px; text-align: center; padding: 10px; border: 2px solid #3498db; border-radius: 8px; }

        /* ìˆœìœ„í‘œ ë ˆì´ì•„ì›ƒ */
        .rank-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .rank-card { flex: 1; min-width: 300px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .rank-header { padding: 10px; color: white; font-weight: bold; }
        
        .senior-header { background: #2980b9; } /* ì¥ë…„ë¶€ íŒŒë‘ */
        .junior-header { background: #27ae60; } /* ì²­ë…„ë¶€ ì´ˆë¡ */
        .female-header { background: #8e44ad; } /* ì—¬ìë¶€ ë³´ë¼ */

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: center; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        th { background: #f8f9fa; color: #555; font-size: 0.8rem; }
        
        /* 1,2,3ìœ„ ê°•ì¡° */
        tr:nth-child(1) td { font-weight: bold; color: #d35400; } 

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
        @media (max-width: 768px) {
            h1 { font-size: 1.2rem; margin: 15px 0; }
            #timerDisplay { font-size: 3.2rem; }
            .timer-box { padding: 20px; }
            .rank-card { min-width: 100%; margin-bottom: 10px; }
            th, td { padding: 8px 4px; font-size: 0.9rem; } /* í°íŠ¸ í¬ê¸° ìœ ì§€ */
            
            /* ë²„íŠ¼ì„ 2ì—´ë¡œ ë°°ì¹˜í•˜ì—¬ í„°ì¹˜ ì˜ì—­ í™•ë³´ */
            .timer-box > div:last-child {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            #startBtn, #resetBtn, #goAdminBtn, #finishBtn, #playerBtn, #logoutBtn {
                margin: 0; width: 100%; font-size: 0.95rem; padding: 12px 0;
            }
            input { width: 120px; font-size: 1.5rem; }
        }

        /* [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•Œë¦¼/ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #toastContainer {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 4000; display: flex; flex-direction: column; align-items: center; gap: 10px;
            pointer-events: none;
        }
        .toast-message {
            background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 25px;
            font-size: 1rem; opacity: 0; transition: opacity 0.3s, transform 0.3s; transform: translateY(-10px);
        }
        .toast-message.show { opacity: 1; transform: translateY(0); }

        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 5000;
        }
        .custom-modal-box {
            background: white; padding: 25px; border-radius: 15px; width: 300px;
            text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .custom-modal-text { margin-bottom: 20px; font-size: 1.1rem; word-break: keep-all; }
        .custom-modal-btns { display: flex; gap: 10px; justify-content: center; }
        .custom-modal-btn {
            flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
        }
        .btn-confirm-yes { background: #e74c3c; color: white; }
        .btn-confirm-no { background: #95a5a6; color: white; }
        .btn-alert-ok { background: #3498db; color: white; width: 100%; }

        /* [ì¶”ê°€] ì¹´ìš´íŠ¸ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
        .countdown-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none;
            justify-content: center; align-items: center; z-index: 6000;
        }
        #countdownNumber {
            font-size: 15rem; color: #f1c40f; font-weight: bold;
            font-variant-numeric: tabular-nums;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* [ì¶”ê°€] ìŒì„±ì¸ì‹ ë°°ë„ˆ ìŠ¤íƒ€ì¼ */
        #voiceStatusBanner {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 50px;
            background: #34495e; color: white; text-align: center; line-height: 50px;
            font-weight: bold; z-index: 3000; cursor: pointer;
        }
        #voiceStatusBanner.listening {
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <div id="voiceStatusBanner">ğŸ”‡ ìŒì„±ì¸ì‹ êº¼ì§ (í„°ì¹˜í•˜ì—¬ ì¼œê¸°)</div>
    <h1 id="raceTitle">ğŸƒë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ</h1>
    <div class="timer-box">
        <div class="info-text">ê²½ê³¼ ì‹œê°„</div>
        <div id="timerDisplay">READY</div>
        <div id="startTimeInfo" class="info-text">[ì„ ìˆ˜ë“¤ì€ GPXë™ì˜ë¥¼ í•´ì£¼ì‹œê³  ê´€ë¦¬ìëŠ” ê´€ë¦¬ìì„¤ì • ë²„íŠ¼ìœ¼ë¡œ ë¡œê·¸ì¸ë¶€íƒë“œë¦½ë‹ˆë‹¤.]</div>
        
        <div style="margin-top: 15px;">
            <button id="playerBtn" onclick="location.href='/player.html'">ğŸ“± ì„ ìˆ˜GPXë™ì˜</button>
            <button id="startBtn" onclick="startRace()" style="display: none;">ğŸ”« ëŒ€íšŒ ì¶œë°œ</button>
            <button id="resetBtn" onclick="resetRace()" style="display: none;">ğŸ”„ ì „ì²´ ì´ˆê¸°í™”</button>
            <button id="goAdminBtn" onclick="goToAdmin()">âš™ï¸ ê´€ë¦¬ì ì„¤ì •</button>
            <button id="logoutBtn" onclick="logoutAdmin()" style="display: none;">ğŸ”“ ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ</button>
            <button id="finishBtn" onclick="finishRace()" style="display: none;">ğŸ ëŒ€íšŒ ì¢…ë£Œ</button>
        </div>
    </div>

    <div class="input-box" style="margin-top:10px; background:#fff3cd;">
        <strong>ğŸ“¡ GPXì¸ì‹ ìë™ê³¨ì¸ ë°˜ê²½: </strong>
        <span id="currentRadiusInfo" style="font-weight:bold; color:#2c3e50;">20m</span>
    </div>

    <div id="finishBibInput" class="input-box" style="display: none;">
        <h3>ğŸ ì™„ì£¼ë°°ë²ˆ ì…ë ¥í›„ Enter</h3>
        <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
            <input type="number" id="bibInput" inputmode="numeric" placeholder="000">
            <button id="micBtn" style="font-size: 1.5rem; padding: 10px; border-radius: 50%; border: none; background: #bdc3c7; cursor: pointer;" title="ìŒì„±ì¸ì‹ ì¼œê¸°/ë„ê¸°">ğŸ¤</button>
        </div>
        <div id="voiceStatus" style="font-size: 0.9rem; color: #e74c3c; margin-top: 5px; min-height: 1.2em; font-weight: bold;"></div>
        <p style="font-size: 0.85rem; color: #555; margin-top: 10px; line-height: 1.4; word-break: keep-all;">
            [ìŒì„±ì¸ì‹ ê³¨ì¸ì€ ë§ˆì´í¬ ë²„íŠ¼ì„ í´ë¦­í•œ í›„ "101ë²ˆ ì™„ì£¼"ë¡œ ì™„ì£¼ì²˜ë¦¬í•˜ê³ , ì˜ëª»ëœ ìŒì„±ì¸ì‹ì´ë‚˜ ì‹¤ìˆ˜í•œê²ƒ ì§€ìš¸ë•ŒëŠ” "101ë²ˆ ì·¨ì†Œ"ë¡œ í•©ë‹ˆë‹¤.]
        </p>
    </div>

    <div class="container">
        <div id="missingSection" class="rank-card" style="display: none; width: 100%; border: 2px solid #e74c3c; margin-bottom: 20px;">
            <div class="rank-header" style="background: #e74c3c;">âš ï¸ ë¯¸ê³¨ì¸ì í˜„í™© (ì”ì—¬ <span id="missingCount">0</span>ëª…)</div>
            <table>
                <thead><tr><th> </th><th>ë°°ë²ˆ</th><th>ì´ë¦„</th><th>ì†Œì†</th><th>ì—°ë½ì²˜</th></tr></thead>
                <tbody id="missingList"></tbody>
            </table>
        </div>

        <div class="rank-container">
            <div class="rank-card">
                <div class="rank-header senior-header">ğŸƒâ€â™‚ï¸ ë‚¨ì ì¥ë…„ë¶€ (<span id="seniorYearText"></span>)</div>
                <table><tbody id="seniorList"></tbody></table>
            </div>
            <div class="rank-card">
                <div class="rank-header junior-header">ğŸƒâ€â™‚ï¸ ë‚¨ì ì²­ë…„ë¶€ (<span id="juniorYearText"></span>)</div>
                <table><tbody id="juniorList"></tbody></table>
            </div>
            <div class="rank-card">
                <div class="rank-header female-header">ğŸƒâ€â™€ï¸ ì—¬ì í†µí•©</div>
                <table><tbody id="femaleList"></tbody></table>
            </div>
        </div>

        <div class="rank-card" style="margin-top: 20px; width: 100%;">
            <div class="rank-header" style="background: #34495e;">ğŸ ì „ì²´ ì™„ì£¼ì ê¸°ë¡ (ìµœì‹ ìˆœ)</div>
            <div style="max-height: 400px; overflow-y: auto;">
                <table>
                    <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 1;">
                        <tr>
                            <th> </th>
                            <th>ë°°ë²ˆ</th>
                            <th>ì´ë¦„</th>
                            <th>ê³µì‹ ê¸°ë¡ (ì‹¬íŒ)</th>
                            <th>ìë™ ê¸°ë¡ (GPX)</th>
                        </tr>
                    </thead>
                    <tbody id="allFinishedList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ì»¤ìŠ¤í…€ ì•Œë¦¼/ëª¨ë‹¬ ìš”ì†Œ -->
    <div id="toastContainer"></div>

    <div id="confirmModal" class="custom-modal-overlay">
        <div class="custom-modal-box">
            <div id="confirmText" class="custom-modal-text">í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
            <div class="custom-modal-btns">
                <button class="custom-modal-btn btn-confirm-no" onclick="closeConfirm(false)">ì·¨ì†Œ</button>
                <button class="custom-modal-btn btn-confirm-yes" onclick="closeConfirm(true)">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="alertModal" class="custom-modal-overlay">
        <div class="custom-modal-box">
            <div id="alertText" class="custom-modal-text">ì•Œë¦¼</div>
            <div class="custom-modal-btns">
                <button class="custom-modal-btn btn-alert-ok" onclick="closeAlert()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="promptModal" class="custom-modal-overlay">
        <div class="custom-modal-box">
            <div id="promptText" class="custom-modal-text">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</div>
            <input type="password" id="promptInput" style="width:90%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:5px; text-align:center;">
            <div class="custom-modal-btns">
                <button class="custom-modal-btn btn-confirm-no" onclick="closePrompt(null)">ì·¨ì†Œ</button>
                <button class="custom-modal-btn btn-alert-ok" onclick="closePrompt(document.getElementById('promptInput').value)">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="countdownOverlay" class="countdown-overlay">
        <div id="countdownNumber">5</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let raceStartTime = null;
        let raceFinishTime = null; // [ì¶”ê°€] ëŒ€íšŒ ì¢…ë£Œ ì‹œê°„
        let timerInterval = null;

        // [ì¶”ê°€] ì˜¤ë””ì˜¤ íš¨ê³¼ìŒ (Web Audio API)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playBeep(type) {
            // ë¸Œë¼ìš°ì € ì •ì±…ìƒ ì‚¬ìš©ì ì¸í„°ë™ì…˜ì´ ì—†ìœ¼ë©´ ì†Œë¦¬ê°€ ì•ˆ ë‚  ìˆ˜ ìˆìŒ (resume ì‹œë„)
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().catch(() => {});
            }
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'count') {
                // ì‚‘ (ì§§ê³  ë†’ì€ìŒ)
                osc.frequency.setValueAtTime(880, audioCtx.currentTime); 
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'start') {
                // ë¹µ (ì¶œë°œ ì‹ í˜¸)
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(440, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.0);
                osc.start();
                osc.stop(audioCtx.currentTime + 1.0);
            }
        }

        // [ìë™ ì„¤ì •] í˜„ì¬ ì—°ë„ ì ìš©
        const currentYear = new Date().getFullYear();
        document.title = `${currentYear} ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ`;
        document.getElementById('raceTitle').innerText = `ğŸƒ${currentYear} ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ`;

        // [ë³´ì•ˆ] ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ (ì„œë²„ì—ì„œ ìˆ˜ì‹ )
        let adminPassword = "LOADING"; 
        socket.on('receive_password', (pw) => {
            adminPassword = pw;
        });

        // [UI] ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (ë¡œê·¸ì¸ í›„ finishBibInput í‘œì‹œ)
        const isAdmin = localStorage.getItem('admin_access') === 'granted';
        if (isAdmin) {
            document.getElementById('finishBibInput').style.display = 'block';
            if(raceStartTime==null){
                document.getElementById('startBtn').style.display = 'inline-block';
            }
            document.getElementById('logoutBtn').style.display = 'inline-block';
            document.getElementById('resetBtn').style.display = 'inline-block';
            if(raceFinishTime==null){
                if(raceStartTime){
                    document.getElementById('finishBtn').style.display = 'inline-block';
                }
            }
        } else {
            document.getElementById('finishBibInput').style.display = 'none';
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('resetBtn').style.display = 'none';
            document.getElementById('finishBtn').style.display = 'none';
        }

        // [ì¶”ê°€] ì»¤ìŠ¤í…€ UI í—¬í¼ í•¨ìˆ˜ë“¤
        function showToast(msg) {
            const container = document.getElementById('toastContainer');
            const el = document.createElement('div');
            el.className = 'toast-message';
            el.innerText = msg;
            container.appendChild(el);
            requestAnimationFrame(() => el.classList.add('show'));
            setTimeout(() => {
                el.classList.remove('show');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        let confirmCallback = null;
        function showConfirm(msg, onYes, onNo) {
            document.getElementById('confirmText').innerText = msg;
            document.getElementById('confirmModal').style.display = 'flex';
            confirmCallback = (result) => {
                if(result && onYes) onYes();
                else if(!result && onNo) onNo();
            };
        }
        function closeConfirm(result) {
            document.getElementById('confirmModal').style.display = 'none';
            if(confirmCallback) confirmCallback(result);
            confirmCallback = null;
        }

        let alertCallback = null;
        function showAlert(msg, onOk) {
            document.getElementById('alertText').innerText = msg;
            document.getElementById('alertModal').style.display = 'flex';
            alertCallback = onOk;
        }
        function closeAlert() {
            document.getElementById('alertModal').style.display = 'none';
            if(alertCallback) alertCallback();
            alertCallback = null;
        }

        let promptCallback = null;
        function showPrompt(msg, onResult) {
            document.getElementById('promptText').innerText = msg;
            document.getElementById('promptInput').value = '';
            document.getElementById('promptModal').style.display = 'flex';
            document.getElementById('promptInput').focus();
            promptCallback = onResult;
        }
        function closePrompt(val) {
            document.getElementById('promptModal').style.display = 'none';
            if(promptCallback) promptCallback(val);
            promptCallback = null;
        }



        // 1. ëŒ€íšŒ ì¶œë°œ
        function startRace() {
            const triggerStart = () => {
                // ë¡œì»¬ ì¹´ìš´íŠ¸ë‹¤ìš´ ëŒ€ì‹  ì„œë²„ì— ì‹œì‘ ìš”ì²­ì„ ë°”ë¡œ ì „ì†¡ (ì„œë²„ê°€ ì¹´ìš´íŠ¸ë‹¤ìš´ ë°©ì†¡)
                socket.emit('start_race');
            };

            if (localStorage.getItem('admin_access') === 'granted') {
                triggerStart();
                return;
            }
            showPrompt("ëŒ€íšŒ ì¶œë°œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (ì¬ì¶œë°œ ì‹œ ê´€ë¦¬ì ì´ˆê¸°í™” í•„ìš”)", (password) => {
                if (password === adminPassword) {
                    triggerStart();
                } else if (password !== null) {
                    showToast("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                }
            });
        }

        // [ì¶”ê°€] ì„œë²„ë¡œë¶€í„° ì¹´ìš´íŠ¸ë‹¤ìš´ ìˆ˜ì‹  (ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ ë™ê¸°í™”)
        socket.on('countdown', (count) => {
            const overlay = document.getElementById('countdownOverlay');
            const num = document.getElementById('countdownNumber');
            
            if (count > 0) {
                overlay.style.display = 'flex';
                num.innerText = count;
                playBeep('count');
            } else {
                overlay.style.display = 'none';
                playBeep('start');
            }
        });

        // ê´€ë¦¬ì í˜ì´ì§€ ì´ë™ ì‹œ ë¹„ë²ˆ í™•ì¸ ë° í† í° ë¶€ì—¬
        function goToAdmin() {
            if (localStorage.getItem('admin_access') === 'granted') {
                location.href = '/admin.html';
                return;
            }
            showPrompt("ê´€ë¦¬ì í˜ì´ì§€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", (password) => {
                if (password === adminPassword) {
                    // ê°„ë‹¨í•œ ì„¸ì…˜ í† í° ì—­í• ì„ í•  ê°’ì„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                    localStorage.setItem('admin_access', 'granted');
                    location.href = '/admin.html';
                } else if (password !== null) {
                    showToast("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                }
            });
        }

        // ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ
        function logoutAdmin() {
            localStorage.removeItem('admin_access');
            location.reload();
        }

        // ëŒ€íšŒ ì¢…ë£Œ
        function finishRace() {
            if (raceFinishTime) {
                showToast("ì´ë¯¸ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                return;
            }

            if (localStorage.getItem('admin_access') === 'granted') {
                if (timerInterval) clearInterval(timerInterval);
                document.querySelector('.timer-box .info-text').innerText = "ëŒ€íšŒê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
                socket.emit('finish_race');
                return;
            }
            showPrompt("ëŒ€íšŒ ì¢…ë£Œë¥¼ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", (password) => {
                if (password === adminPassword) {
                    if (timerInterval) clearInterval(timerInterval);
                    document.querySelector('.timer-box .info-text').innerText = "ëŒ€íšŒê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
                    socket.emit('finish_race'); // ì„œë²„ì— ë¯¸ì™„ì£¼ì ì¼ê´„ ì²˜ë¦¬ ìš”ì²­
                } else if (password !== null) {
                    showToast("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                }
            });
        }

        // ë¦¬ì…‹ í•¨ìˆ˜
        function resetRace() {
            showConfirm("âš ï¸ ê²½ê³ : ëª¨ë“  ì„ ìˆ˜ì˜ ì¶œë°œ ë° ë„ì°© ê¸°ë¡ì´ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => {
                if (localStorage.getItem('admin_access') === 'granted') {
                    socket.emit('reset_race');
                    return;
                }
                showPrompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”", (password) => {
                    if(password === adminPassword) { // ê°„ë‹¨í•œ ë³´ì•ˆ ì¥ì¹˜
                        socket.emit('reset_race');
                    } else if (password !== null) {
                        showToast("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                    }
                });
            });
        }

        socket.on('current_settings', (data) => {
            if(data.goalRadius) document.getElementById('currentRadiusInfo').innerText = `${data.goalRadius}m`;
            if(data.seniorYear) updateYearDisplay(data.seniorYear);
        });

        socket.on('radius_changed', (val) => {
            document.getElementById('currentRadiusInfo').innerText = `${val}m`;
        });

        // [ì¶”ê°€] ì„¤ì • ë³€ê²½ ì‹¤ì‹œê°„ ë°˜ì˜
        socket.on('settings_changed', (data) => {
            if(data.seniorYear) updateYearDisplay(data.seniorYear);
        });

        function updateYearDisplay(year) {
            const yy = String(year).slice(-2);
            const nextYy = String(year + 1).slice(-2);
            document.getElementById('seniorYearText').innerText = `~${yy}ë…„`;
            document.getElementById('juniorYearText').innerText = `${nextYy}ë…„~`;
        }

        // ì„œë²„ë¡œë¶€í„° ë¦¬ì…‹ ì™„ë£Œ ì‹ í˜¸ë¥¼ ë°›ìœ¼ë©´ í™”ë©´ ìƒˆë¡œê³ ì¹¨
        socket.on('race_reset_complete', () => {
            showToast("ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload(); // í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”
        });

        // 2. íƒ€ì´ë¨¸ ì‘ë™ ë¡œì§
        socket.on('race_status', (data) => {
            if (data.isStarted) {
                document.getElementById('countdownOverlay').style.display = 'none'; // ëŒ€íšŒ ì‹œì‘ ì‹œ ì¹´ìš´íŠ¸ë‹¤ìš´ ìˆ¨ê¹€ ë³´ì¥
                raceStartTime = new Date(data.startTime);
                raceFinishTime = data.finishTime ? new Date(data.finishTime) : null; // [ì¶”ê°€] ì¢…ë£Œ ì‹œê°„ ì„¤ì •
                
                // 1. ë²„íŠ¼ ë¹„í™œì„±í™” ë° ìŠ¤íƒ€ì¼ ë³€ê²½
                const btn = document.getElementById('startBtn');
                btn.disabled = true; // í´ë¦­ ë¶ˆê°€
                btn.style.display = 'none'; // ë˜ëŠ” ì•„ì˜ˆ ìˆ¨ê¹€
                btn.innerText = "ëŒ€íšŒ ì§„í–‰ ì¤‘";
                if (localStorage.getItem('admin_access') === 'granted') {
                    document.getElementById('finishBtn').style.display = 'inline-block';//ëŒ€íšŒì¢…ë£Œë²„íŠ¼ ë³´ì„.
                }
                
                // 2. íƒ€ì´ë¨¸ ë ˆì´ë¸” ë³€ê²½
                document.getElementById('startTimeInfo').innerText = "ì¶œë°œ ì‹œê°: " + raceStartTime.toLocaleTimeString();
                
                // [ì¶”ê°€] ëŒ€íšŒê°€ ì¢…ë£Œëœ ìƒíƒœë©´ íƒ€ì´ë¨¸ ì‹¤í–‰ ì•ˆ í•¨
                if (data.isFinished) {
                    document.querySelector('.timer-box .info-text').innerText = "ëŒ€íšŒê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
                    document.querySelector('.timer-box').style.background = "linear-gradient(135deg, #c0392b 0%, #e74c3c 100%)";
                    document.getElementById('finishBtn').style.display = 'none';//ëŒ€íšŒì¢…ë£Œë²„íŠ¼ ìˆ¨ê¹€.
                    document.getElementById('finishBibInput').style.display = 'none';
                    document.getElementById('voiceStatusBanner').style.display = 'none';
                    updateTimer(); // í˜„ì¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ í•œ ë²ˆ í‘œì‹œ í›„ ì •ì§€
                    return;
                }

                // 3. íƒ€ì´ë¨¸ ê°€ë™
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(updateTimer, 1000);
            }
        });

        function updateTimer() {
            if (!raceStartTime) return;
            // [ë³€ê²½] ì¢…ë£Œ ì‹œê°„ì´ ìˆìœ¼ë©´ ì¢…ë£Œ ì‹œê°„ ê¸°ì¤€, ì—†ìœ¼ë©´ í˜„ì¬ ì‹œê°„ ê¸°ì¤€
            const now = raceFinishTime ? raceFinishTime : new Date();
            const diff = now - raceStartTime;
            
            const h = Math.floor(diff / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('timerDisplay').innerText = 
                `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        // 3. ë°°ë²ˆ ì…ë ¥ ì „ì†¡
        const bibInput = document.getElementById('bibInput');
        bibInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && bibInput.value) {
                socket.emit('runner_arrived', bibInput.value);
                bibInput.value = '';
            }
        });

        // [ì¶”ê°€] ìŒì„± ì¸ì‹ ê¸°ëŠ¥ (Web Speech API)
        const micBtn = document.getElementById('micBtn');
        const voiceStatus = document.getElementById('voiceStatus');
        const voiceBanner = document.getElementById('voiceStatusBanner');
        let isVoiceActive = false;
        let recognition = null;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.continuous = true; // ì§€ì†ì  ì¸ì‹
            recognition.interimResults = false;
            
            // ê´€ë¦¬ìë¼ë©´ ë°°ë„ˆ í‘œì‹œ ë° ì—¬ë°± í™•ë³´
            if (localStorage.getItem('admin_access') === 'granted') {
                voiceBanner.style.display = 'block';
                document.body.style.paddingTop = '50px';
            }

            recognition.onstart = () => {
                isVoiceActive = true;
                micBtn.style.background = '#e74c3c'; 
                micBtn.style.color = '#fff';
                voiceStatus.innerText = "ğŸ¤ ë“£ê³  ìˆìŠµë‹ˆë‹¤... ('101ë²ˆ ì™„ì£¼' ë˜ëŠ” 'ì·¨ì†Œ')";
                voiceBanner.innerText = "ğŸ¤ ìŒì„±ì¸ì‹ ì¤‘... ('101ë²ˆ ì™„ì£¼/ì·¨ì†Œ')";
                voiceBanner.classList.add('listening');
            };

            recognition.onend = () => {
                if (isVoiceActive) {
                    recognition.start(); // ê³„ì† ë“£ê¸° ìœ ì§€ (ì¬ì‹œì‘)
                } else {
                    micBtn.style.background = '#bdc3c7';
                    micBtn.style.color = '#000';
                    voiceStatus.innerText = "";
                    voiceBanner.innerText = "ğŸ”‡ ìŒì„±ì¸ì‹ êº¼ì§ (í„°ì¹˜í•˜ì—¬ ì¼œê¸°)";
                    voiceBanner.classList.remove('listening');
                }
            };

            recognition.onresult = (event) => {
                const last = event.results.length - 1;
                const transcript = event.results[last][0].transcript.trim();
                
                // ì •ê·œì‹: ìˆ«ì + (ê³µë°±/ë²ˆ) + (ì™„ì£¼|ì·¨ì†Œ)
                const match = transcript.match(/(\d+)\s*(ë²ˆ)?\s*(ì™„ì£¼|ì·¨ì†Œ)/);
                if (match) {
                    const bib = match[1];
                    const command = match[3];
                    
                    if (command === 'ì™„ì£¼') {
                        showToast(`ğŸ¤ ìŒì„±ì¸ì‹: ${bib}ë²ˆ ì™„ì£¼ ì²˜ë¦¬`);
                        socket.emit('runner_arrived', bib);
                    } else if (command === 'ì·¨ì†Œ') {
                        showToast(`ğŸ¤ ìŒì„±ì¸ì‹: ${bib}ë²ˆ ê¸°ë¡ ì·¨ì†Œ ìš”ì²­`);
                        socket.emit('cancel_runner_finish', bib);
                    }
                }
            };

            micBtn.addEventListener('click', () => {
                if (isVoiceActive) {
                    isVoiceActive = false;
                    recognition.stop();
                } else {
                    recognition.start();
                }
            });
            
            voiceBanner.addEventListener('click', () => {
                micBtn.click();
            });
        } else {
            micBtn.style.display = 'none';
        }

        socket.on('error_msg', (msg) => showToast(msg));
        socket.on('runner_finished', (runner) => {
            showToast(`[ì™„ì£¼:${runner.bibNumber}]`);
        });
        
        socket.on('update_ui', (data) => {
            // 1. ë¯¸ê³¨ì¸ì ì²˜ë¦¬ (20ëª… ë¯¸ë§Œ ì‹œ ë…¸ì¶œ)
            const count = data.notFinished.length;
            const missingSection = document.getElementById('missingSection');
            if (count > 0 && count < 20) {
                missingSection.style.display = 'block';
                document.getElementById('missingCount').innerText = count;
                renderMissingTable('missingList', data.notFinished);
            } else {
                missingSection.style.display = 'none';
            }

            // 2. ë¶€ë¬¸ë³„ ì…ìƒì ì²˜ë¦¬
            renderRankTable('seniorList', data.maleSenior);
            renderRankTable('juniorList', data.maleJunior);
            renderRankTable('femaleList', data.female);

            // 3. ì „ì²´ ê³¨ì¸ì ì²˜ë¦¬
            renderAllFinishedTable('allFinishedList', data.allFinished);
        });

        function renderRankTable(elementId, runners) {
            const tbody = document.getElementById(elementId);
            tbody.innerHTML = '';
            runners.forEach((r, index) => {
                // ê²½ê³¼ ì‹œê°„ ê³„ì‚°
                const record = new Date(new Date(r.finishTime) - new Date(r.startTime));
                const recordStr = record.toISOString().substr(11, 8); // HH:MM:SS í˜•ì‹

                const row = `<tr>
                    <td>${index + 1}</td>
                    <td>${r.bibNumber}</td>
                    <td>${r.name || '-'}</td>
                    <td>${recordStr}</td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        function renderAllFinishedTable(elementId, runners) {
            const tbody = document.getElementById(elementId);
            tbody.innerHTML = '';
            const totalCount = runners.length;
            runners.forEach((r, index) => {
                // ê³µì‹ ê¸°ë¡ ê³„ì‚°
                const manualRecord = r.finishTime ? 
                    new Date(new Date(r.finishTime) - new Date(r.startTime)).toISOString().substr(11, 8) : "-";
                
                // ìë™ ê¸°ë¡ ê³„ì‚°
                const autoRecord = r.autoFinishTime ? 
                    new Date(new Date(r.autoFinishTime) - new Date(r.startTime)).toISOString().substr(11, 8) : "-";

                const row = `<tr>
                    <td>${totalCount - index}</td>
                    <td>${r.bibNumber}</td>
                    <td>${r.name}</td>
                    <td style="font-weight:bold; color:#2c3e50;">${manualRecord}</td>
                    <td style="color:#7f8c8d; font-size:0.85rem;">${autoRecord}</td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        function renderMissingTable(elementId, runners) {
            const tbody = document.getElementById(elementId);
            tbody.innerHTML = '';
            runners.forEach((r, index) => {
                const row = `<tr>
                    <td>${index + 1}</td>
                    <td>${r.bibNumber}</td>
                    <td>${r.name}</td>
                    <td>${r.affiliation}</td>
                    <td>${r.phone}</td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }
    </script>
</body>
</html>