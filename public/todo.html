<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ì´ë“¤ ì‹œê°„ íƒí—˜ëŒ€</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg-color: #f0f9ff; --border-bold: 2px solid #3498db; --border-dot: 1px dashed #bdc3c7; }
        * { box-sizing: border-box; }
        body { font-family: 'Jua', sans-serif; background: var(--bg-color); margin: 0; padding: 20px; }
        
        /* ì—„ë§ˆì˜ Todo ì°½ê³  */
        .todo-storage { 
            background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 0 #ddd;
            display: flex; gap: 10px; margin-bottom: 30px; border: 3px solid #3498db;
        }
        .todo-item:active { cursor: grabbing; transform: translateY(4px); }
        
        /* ë§ˆìŠ¤í„° ì‚­ì œ ë²„íŠ¼ */
        .btn-del-master {
            margin-left: 5px; cursor: pointer; font-size: 0.8rem; opacity: 0.6;
        }
        .btn-del-master:hover { opacity: 1; color: red; }

        /* ì´í‹€ì¹˜ ì»¨í…Œì´ë„ˆ */
        .days-container { display: flex; gap: 20px; overflow-x: auto; }
        .day-column { flex: 1; min-width: 400px; background: white; border-radius: 20px; padding: 15px; }
        
        /* ì‹œê°„í‘œ í…Œì´ë¸” */
        .schedule-table { width: 100%; border-collapse: collapse; }
        .time-row { height: 50px; }
        .time-row.on-hour { border-top: var(--border-bold); } /* ì •ì‹œ ì‹¤ì„  */
        .time-row.half-hour { border-top: var(--border-dot); } /* 30ë¶„ ì ì„  */
        
        .time-label { width: 60px; text-align: center; font-size: 0.9rem; color: #7f8c8d; }
        .child-slot { width: 30%; border-left: 1px solid #eee; position: relative; }
        .slot-inner { min-height: 40px; display: flex; flex-wrap: wrap; gap: 4px; padding: 5px; }
        
        .child-header { text-align: center; font-size: 1.2rem; padding: 10px 0; background: #3498db; color: white; border-radius: 10px 10px 0 0; }
        
        .nav-btns { margin-bottom: 10px; display: flex; justify-content: space-between; }
        /* [ìˆ˜ì •] ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì›í˜•ìœ¼ë¡œ ë³€ê²½ */
        .nav-btns button { 
            width: 40px; height: 40px; border-radius: 50%; padding: 0; border: none; 
            background: #e67e22; color: white; cursor: pointer; font-size: 1.2rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }

        /* ìƒë‹¨ í—¤ë” */
        .header-section { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .btn-add-todo { background: #6c5ce7; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #4834d4; transition: 0.2s; }
        .btn-add-todo:active { transform: translateY(4px); box-shadow: none; }
        .btn-excel { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #219150; transition: 0.2s; margin-right: 10px; }
        .btn-excel:active { transform: translateY(4px); box-shadow: none; }
        .btn-star { background: #f1c40f; color: #2d3436; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #f39c12; transition: 0.2s; margin-right: 10px; }
        .btn-star:active { transform: translateY(4px); box-shadow: none; }

        /* ëª¨ë‹¬ì°½(íŒì—…) ìŠ¤íƒ€ì¼ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border: 4px solid #a29bfe; }
        .input-group { margin: 15px 0; text-align: left; }
        .input-group input[type="text"] { width: 90%; padding: 10px; border: 2px solid #dfe6e9; border-radius: 10px; font-size: 1rem; }

        /* ìƒ‰ìƒ ì„ íƒê¸° */
        .color-options { display: flex; gap: 10px; margin-top: 5px; justify-content: center; }
        .color-circle { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: 0.2s; }
        .color-circle:hover { transform: scale(1.2); }
        .color-circle.selected { border-color: #2d3436; transform: scale(1.1); }
        
        /* [ìˆ˜ì •] ëª¨ë‹¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°œì„  */
        .modal-btns { display: flex; justify-content: center; gap: 15px; margin-top: 25px; }
        .modal-btns button {
            flex: 1; padding: 12px; border: none; border-radius: 15px; 
            color: white; font-weight: bold; cursor: pointer; font-size: 1rem;
            box-shadow: 0 4px 0 rgba(0,0,0,0.15); transition: transform 0.1s;
        }
        .modal-btns button:active { transform: translateY(3px); box-shadow: none; }

        /* í•  ì¼ ì•„ì´í…œ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        .todo-item { 
            position: relative; /* ì‚­ì œ ë²„íŠ¼ ë“±ì„ ìœ„í•´ */
            width: 100%;
            z-index: 10;
            margin-bottom: 2px;
            font-size: 0.85rem;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: 8px;
            overflow: hidden;
        }
        .todo-text {
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* ê¸°ê°„ì— ë”°ë¥¸ ë†’ì´ ì„¤ì • (30ë¶„ë‹¹ ì•½ 50px) */
        .todo-item[data-duration="2"] { height: calc(100px - 4px); z-index: 20; }
        .todo-item[data-duration="3"] { height: calc(150px - 4px); z-index: 20; }
        /* ... í•„ìš”í•œ ë§Œí¼ ì¶”ê°€ ë˜ëŠ” JSì—ì„œ ë™ì  ê³„ì‚° */

        .btn-delete-plan {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: #ff7675;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
        }

        /* ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œë§Œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ (PCìš©) */
        .todo-item:hover .btn-delete-plan {
            display: flex;
        }

        /* ëª¨ë°”ì¼ìš© ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ */
        .mobile-menu {
            position: fixed; background: white; border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2); display: none;
            flex-direction: column; z-index: 2000; overflow: hidden;
        }
        .mobile-menu button {
            padding: 15px 25px; border: none; background: white;
            font-weight: bold; border-bottom: 1px solid #eee;
        }
        .mobile-menu button.del { color: #e74c3c; }

        @media (max-width: 768px) {
            .day-column { min-width: 100%; }
            /* [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ í¬ê¸° ì¶•ì†Œ ë° ì •ë ¬ */
            .btn-add-todo, .btn-excel, .btn-star { padding: 8px 10px; font-size: 0.8rem; margin-right: 2px; }
            .header-section h2 { font-size: 1.2rem; }
            
            /* [ì¶”ê°€] ëª¨ë°”ì¼ì—ì„œ ë³´ë¬¼ì°½ê³  ì˜ì—­ í™•ì¥ (3ì¤„ ì •ë„) */
            .todo-storage { 
                flex-wrap: wrap; height: 180px; overflow-y: auto; align-content: flex-start; 
            }
            .todo-storage .todo-item { width: auto; }
            .todo-item { margin: 2px; font-size: 0.9rem; padding: 8px 12px; }
        }

        /* [ì¶”ê°€] íœ´ì§€í†µ ìŠ¤íƒ€ì¼ */
        .trash-drop-zone {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 220px; height: 70px;
            background: #ff7675; color: white;
            border-radius: 35px;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            font-size: 1.2rem; font-weight: bold;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 3000;
            opacity: 0; pointer-events: none; transition: opacity 0.3s, transform 0.2s;
        }
        .trash-drop-zone.active { opacity: 1; pointer-events: auto; }

        /* [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•Œë¦¼/ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .toast-message {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 25px;
            font-size: 1rem; z-index: 4000; opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .toast-message.show { opacity: 1; }

        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 5000;
        }
        .custom-modal-box {
            background: white; padding: 25px; border-radius: 15px; width: 300px;
            text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .custom-modal-text { margin-bottom: 20px; font-size: 1.1rem; word-break: keep-all; }
        .custom-modal-btns { display: flex; gap: 10px; justify-content: center; }
        .custom-modal-btn {
            flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
        }
        .btn-confirm-yes { background: #e74c3c; color: white; }
        .btn-confirm-no { background: #95a5a6; color: white; }
        .btn-alert-ok { background: #3498db; color: white; width: 100%; }
    </style>
</head>
<body>

    <div class="header-section">
        <h2>ğŸ’ í•  ì¼ ë³´ë¬¼ì°½ê³ </h2>
        <div>
            <button id="momBtn" onclick="toggleMomLogin()" class="btn-star">â­ë³„</button>
            <button onclick="downloadScheduleExcel()" class="btn-excel">ğŸ“Šì—‘ì…€</button>
            <button onclick="openModal()" class="btn-add-todo">+í• ì¼</button>
        </div>
    </div>

    <div class="todo-storage" id="masterTodos">
        <div style="color:#aaa; padding:10px;">ë¡œë”© ì¤‘...</div>
    </div>

    <div id="todoModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>âœ¨ ìƒˆë¡œìš´ í• ì¼ ë§Œë“¤ê¸°</h3>
            <div class="input-group">
                <label>ì´ë¦„:</label>
                <input type="text" id="newTodoTitle" placeholder="ì˜ˆ: ë…ì„œ, í”¼ì•„ë…¸, ì¤„ë„˜ê¸°">
            </div>
            <div class="input-group">
                <label>ì†Œìš” ì‹œê°„:</label>
                <select id="newTodoDuration" style="width:100%; padding:10px; border-radius:10px;">
                    <option value="1">30ë¶„</option>
                    <option value="2">1ì‹œê°„</option>
                    <option value="3">1ì‹œê°„ 30ë¶„</option>
                    <option value="4">2ì‹œê°„</option>
                    <option value="5">2ì‹œê°„ 30ë¶„</option>
                    <option value="6">3ì‹œê°„</option>
                    <option value="7">3ì‹œê°„ 30ë¶„</option>
                    <option value="8">4ì‹œê°„</option>
                    <option value="9">4ì‹œê°„ 30ë¶„</option>
                    <option value="10">5ì‹œê°„</option>
                </select>
            </div>
            <div class="input-group">
                <label>ìƒ‰ìƒ ì„ íƒ:</label>
                <div class="color-options" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px;">
                    <div class="color-circle selected" style="background:#ff7675" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#74b9ff" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#55efc4" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#fab1a0" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#a29bfe" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#ffeaa7" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#fdcb6e" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#e84393" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#00cec9" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#6c5ce7" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#b2bec3" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#2d3436" onclick="selectColor(this)"></div>
                </div>
                <input type="hidden" id="selectedColor" value="#ff7675">
            </div>
            <div class="modal-btns">
                <button onclick="closeModal()" style="background:#95a5a6">ì·¨ì†Œ</button>
                <button onclick="saveNewMaster()" style="background:#00b894">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div class="nav-btns">
        <button onclick="moveDate(-1)">&lt;</button>
        <div style="display: flex; align-items: center; gap: 10px;">
            <h2 id="dateRange" style="margin: 0;">ë‚ ì§œ ë¡œë”© ì¤‘...</h2>
            <button onclick="goToToday()" style="width: auto; height: 30px; font-size: 0.8rem; border-radius: 15px; padding: 0 10px;">Today</button>
        </div>
        <button onclick="moveDate(1)">&gt;</button>
    </div>

    <div class="days-container" id="scheduleBoard">
        <div class="day-column">
            <h3 align="center">ì˜¤ëŠ˜ (5ì›” 20ì¼)</h3>
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th></th>
                        <th class="child-header" style="background:#ff9f43">í•˜ëŒ</th>
                        <th class="child-header" style="background:#54a0ff">ì›€ì°¬</th>
                        <th class="child-header" style="background:#5f27cd">íƒœë‘</th>
                    </tr>
                </thead>
                <tbody id="timeGrid">
                    </tbody>
            </table>
        </div>
        </div>

    <div id="trashCan" class="trash-drop-zone">ğŸ—‘ï¸ ì—¬ê¸°ë¡œ ë“œë˜ê·¸</div>

    <!-- ì»¤ìŠ¤í…€ ì•Œë¦¼/ëª¨ë‹¬ ìš”ì†Œ -->
    <div id="toastMessage" class="toast-message">ì•Œë¦¼</div>

    <div id="confirmModal" class="custom-modal-overlay">
        <div class="custom-modal-box">
            <div id="confirmText" class="custom-modal-text">í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
            <div class="custom-modal-btns">
                <button class="custom-modal-btn btn-confirm-no" onclick="closeConfirm(false)">ì·¨ì†Œ</button>
                <button class="custom-modal-btn btn-confirm-yes" onclick="closeConfirm(true)">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="promptModal" class="custom-modal-overlay">
        <div class="custom-modal-box">
            <div id="promptText" class="custom-modal-text">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</div>
            <input type="password" id="promptInput" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:5px; text-align:center;">
            <div class="custom-modal-btns">
                <button class="custom-modal-btn btn-confirm-no" onclick="closePrompt(null)">ì·¨ì†Œ</button>
                <button class="custom-modal-btn btn-alert-ok" onclick="closePrompt(document.getElementById('promptInput').value)">í™•ì¸</button>
            </div>
        </div>
    </div>

<script>
    const API_BASE = '/api/todo'; 
    // [ìˆ˜ì •] ì €ì¥ëœ ë‚ ì§œê°€ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì˜¤ê³ , ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©
    const savedDate = localStorage.getItem('todoCurrentDate');
    let currentDate = savedDate ? new Date(savedDate) : new Date();

    let daysToShow = 2; // ê¸°ë³¸ê°’ (PC)
    let isMomMode = false; // ì—„ë§ˆ ë¡œê·¸ì¸ ìƒíƒœ
    let activeChild = null; // [ì¶”ê°€] ì•„ì´ ì„ íƒ ìƒíƒœ (ì‹¤ìˆ˜ ë°©ì§€ìš©)

    // [ì¶”ê°€] ì»¤ìŠ¤í…€ UI í—¬í¼ í•¨ìˆ˜ë“¤
    let confirmCallback = null;
    function showConfirm(msg, onYes, onNo) {
        document.getElementById('confirmText').innerText = msg;
        document.getElementById('confirmModal').style.display = 'flex';
        confirmCallback = (result) => {
            if(result && onYes) onYes();
            else if(!result && onNo) onNo();
        };
    }
    function closeConfirm(result) {
        document.getElementById('confirmModal').style.display = 'none';
        if(confirmCallback) confirmCallback(result);
        confirmCallback = null;
    }

    let promptCallback = null;
    function showPrompt(msg, onResult) {
        document.getElementById('promptText').innerText = msg;
        document.getElementById('promptInput').value = '';
        document.getElementById('promptModal').style.display = 'flex';
        document.getElementById('promptInput').focus();
        promptCallback = onResult;
    }
    function closePrompt(val) {
        document.getElementById('promptModal').style.display = 'none';
        if(promptCallback) promptCallback(val);
        promptCallback = null;
    }

    function showToast(msg) {
        const el = document.getElementById('toastMessage');
        el.innerText = msg;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 2000);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', () => {
        checkMomMode(); // ì—„ë§ˆ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        updateDaysToShow();
        loadMasters();    // 1. ì—„ë§ˆì˜ í•  ì¼ ëª©ë¡ ë¡œë“œ
        renderSchedule(); // 2. ì‹œê°„í‘œ ê·¸ë¦¬ê¸° ë° ë°ì´í„° ë¡œë“œ
        initTrashCan();   // [ì¶”ê°€] íœ´ì§€í†µ ì´ˆê¸°í™”
    });

    // í™”ë©´ í¬ê¸° ë³€ê²½ ê°ì§€
    window.addEventListener('resize', () => {
        const prevDays = daysToShow;
        updateDaysToShow();
        if (prevDays !== daysToShow) renderSchedule();
    });

    // =========================================
    // 1. ë‚ ì§œ ë° ê·¸ë¦¬ë“œ ë Œë”ë§ (í•µì‹¬ ë¡œì§)
    // =========================================

    function updateDaysToShow() {
        daysToShow = window.matchMedia("(max-width: 768px)").matches ? 1 : 2;
    }

    // ë‚ ì§œ ì´ë™ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ
    function moveDate(direction) {
        // direction: -1 (ì´ì „), 1 (ë‹¤ìŒ)
        currentDate.setDate(currentDate.getDate() + (direction * daysToShow));
        localStorage.setItem('todoCurrentDate', currentDate.toISOString()); // ë‚ ì§œ ì €ì¥
        renderSchedule(); // ë‚ ì§œê°€ ë°”ë€Œì—ˆìœ¼ë‹ˆ ê·¸ë¦¬ë“œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    }

    // [ì¶”ê°€] ì˜¤ëŠ˜ ë‚ ì§œë¡œ ë°”ë¡œ ì´ë™
    function goToToday() {
        currentDate = new Date();
        localStorage.setItem('todoCurrentDate', currentDate.toISOString());
        renderSchedule();
    }

    // ë‚ ì§œ í¬ë§· í—¬í¼ (YYYY-MM-DD) - ì„œë²„ ì „ì†¡ìš©
    function getIsoDate(dateObj) {
        const offset = dateObj.getTimezoneOffset() * 60000;
        return new Date(dateObj.getTime() - offset).toISOString().split('T')[0];
    }

    // ë‚ ì§œ í¬ë§· í—¬í¼ (Mì›” Dì¼) - í™”ë©´ í‘œì‹œìš©
    function getDisplayDate(dateObj) {
        const dateStr = dateObj.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' });
        const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        return `${dateStr} (${dayNames[dateObj.getDay()]})`;
    }

    // ê·¸ë¦¬ë“œ ì „ì²´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    async function renderSchedule() {
        const gridContainer = document.getElementById('scheduleBoard');
        const dateRangeText = document.getElementById('dateRange');
        
        gridContainer.innerHTML = ''; // ê¸°ì¡´ í‘œ ì‚­ì œ

        // í‘œì‹œí•  ë‚ ì§œ ë°°ì—´ ìƒì„±
        const dates = [];
        for (let i = 0; i < daysToShow; i++) {
            const d = new Date(currentDate);
            d.setDate(d.getDate() + i);
            dates.push(d);
        }

        // ìƒë‹¨ ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
        if (daysToShow === 1) {
            dateRangeText.innerText = getDisplayDate(dates[0]);
        } else {
            dateRangeText.innerText = `${getDisplayDate(dates[0])} - ${getDisplayDate(dates[dates.length - 1])}`;
        }

        // ë£¨í”„ ëŒë©´ì„œ í‘œ ìƒì„±
        dates.forEach(dateObj => {
            const dateStr = getDisplayDate(dateObj);   // í™”ë©´ìš©
            const isoDate = getIsoDate(dateObj);       // ë°ì´í„°ìš© (YYYY-MM-DD)

            let html = `
                <div class="day-column" data-date="${isoDate}">
                    <h3 align="center">${dateStr}</h3>
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th class="child-header" style="background:#ff9f43; cursor:pointer;" onclick="setActiveChild('í•˜ëŒ')">í•˜ëŒ</th>
                                <th class="child-header" style="background:#54a0ff; cursor:pointer;" onclick="setActiveChild('ì›€ì°¬')">ì›€ì°¬</th>
                                <th class="child-header" style="background:#5f27cd; cursor:pointer;" onclick="setActiveChild('íƒœë‘')">íƒœë‘</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // 08:00 ~ 21:30 ì‹œê°„ ìŠ¬ë¡¯ ìƒì„±
            for(let h=8; h<=21; h++) {
                ['00', '30'].forEach(m => {
                    const isHour = (m === '00');
                    const time = `${String(h).padStart(2,'0')}:${m}`;
                    
                    let displayTime = '';
                    if (isHour) {
                        const ampm = h < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
                        const hour12 = h > 12 ? h - 12 : h;
                        displayTime = `${ampm} ${hour12}:${m}`;
                    }

                    html += `
                        <tr class="time-row ${isHour ? 'on-hour' : 'half-hour'}">
                            <td class="time-label">${displayTime}</td>
                            <td class="child-slot" data-child="í•˜ëŒ" data-time="${time}" data-date="${isoDate}">
                                <div class="slot-inner"></div>
                            </td>
                            <td class="child-slot" data-child="ì›€ì°¬" data-time="${time}" data-date="${isoDate}">
                                <div class="slot-inner"></div>
                            </td>
                            <td class="child-slot" data-child="íƒœë‘" data-time="${time}" data-date="${isoDate}">
                                <div class="slot-inner"></div>
                            </td>
                        </tr>
                    `;
                });
            }
            html += `</tbody></table></div>`;
            gridContainer.insertAdjacentHTML('beforeend', html);
        });

        // 3. í‘œë¥¼ ë‹¤ ê·¸ë ¸ìœ¼ë‹ˆ, ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ í™œì„±í™”
        initSortableSlots();

        // 4. ì„œë²„ì—ì„œ ì´ ë‚ ì§œë“¤ì˜ ê³„íš ë¶ˆëŸ¬ì˜¤ê¸°
        await loadPlans(getIsoDate(dates[0]), getIsoDate(dates[dates.length - 1]));
    }

    // =========================================
    // 2. ë“œë˜ê·¸ ì•¤ ë“œë¡­ (SortableJS) ì—°ê²°
    // =========================================
    function initSortableSlots() {
        document.querySelectorAll('.slot-inner').forEach(slot => {
            new Sortable(slot, {
                group: 'shared',
                animation: 150,
                delay: 100, // ëª¨ë°”ì¼ í„°ì¹˜ ì¸ì‹ì„ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° ì¶”ê°€
                delayOnTouchOnly: true,
                onStart: () => toggleTrash(true), // [ì¶”ê°€] ë“œë˜ê·¸ ì‹œì‘ ì‹œ íœ´ì§€í†µ í‘œì‹œ
                onEnd: () => toggleTrash(false),   // [ì¶”ê°€] ë“œë˜ê·¸ ì¢…ë£Œ ì‹œ íœ´ì§€í†µ ìˆ¨ê¹€
                onMove: function (evt) {
                    // [ì¶”ê°€] ì„ íƒëœ ì•„ì´ê°€ ìˆì„ ê²½ìš° ë‹¤ë¥¸ ì•„ì´ ìŠ¬ë¡¯ ì§„ì… ì°¨ë‹¨
                    if (activeChild) {
                        const targetChild = evt.to.parentElement.dataset.child;
                        if (targetChild && targetChild !== activeChild) return false;
                    }
                },
                onAdd: async function (evt) {
                    const parentTd = evt.to.parentElement; 
                    const child = parentTd.dataset.child;

                    // [ì¶”ê°€] ë¹„í™œì„±í™”ëœ ìŠ¬ë¡¯(ë‹¤ë¥¸ ì•„ì´)ì— ë“œë¡­ ì‹œ ì°¨ë‹¨
                    if (activeChild && activeChild !== child) {
                        evt.item.remove(); // ì˜ëª» ë“¤ì–´ì˜¨ ì•„ì´í…œ ì œê±°
                        return;
                    }

                    const item = evt.item;
                    const masterId = item.dataset.id;
                    // [ìˆ˜ì •] ì•„ì´í…œì— ì €ì¥ëœ duration(ì§€ì†ì‹œê°„) ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸ê°’ 1)
                    const duration = item.dataset.duration || 1; 
                    
                    const time = parentTd.dataset.time;
                    const date = parentTd.dataset.date;

                    const fromList = evt.from;

                    // 1. ë³´ë¬¼ì°½ê³ ì—ì„œ ì˜¨ ê²½ìš° -> ì‹ ê·œ ì €ì¥ (duration í¬í•¨)
                    if (fromList.id === 'masterTodos') {
                        // [ìˆ˜ì •] savePlan í˜¸ì¶œ ì‹œ duration ì¸ì ì¶”ê°€
                        const saved = await savePlan(masterId, child, date, time, duration);
                        if(saved) {
                            item.dataset.planId = saved.id;
                            renderSchedule(); // ë†’ì´ ì¡°ì ˆ ë“±ì„ ìœ„í•´ í™”ë©´ ìƒˆë¡œê³ ì¹¨
                        }
                    } 
                    // 2. ë‹¤ë¥¸ ì‹œê°„ëŒ€ì—ì„œ ì´ë™í•œ ê²½ìš° (Update)
                    else {
                        const fromParentTd = fromList.parentElement;
                        const fromChild = fromParentTd.dataset.child;

                        if (fromChild !== child) {
                            showToast("ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ì˜®ê¸¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                            fromList.insertBefore(item, fromList.children[evt.oldIndex] || null);
                            return;
                        }

                        const planId = item.dataset.planId;
                        if (planId) {
                            const success = await updatePlan(planId, date, time);
                            if (!success) {
                                fromList.insertBefore(item, fromList.children[evt.oldIndex] || null);
                            } else {
                                renderSchedule(); // ìœ„ì¹˜/ë„ˆë¹„ ì¬ì¡°ì •ì„ ìœ„í•´ í™”ë©´ ê°±ì‹ 
                            }
                        }
                    }
                }
            });
        });
    }

    // =========================================
    // 3. ì„œë²„ í†µì‹  (ë°ì´í„° ë¡œë“œ & ì €ì¥)
    // =========================================

    // ì—„ë§ˆì˜ í•  ì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    async function loadMasters() {
        try {
            const res = await fetch(`${API_BASE}/masters`);
            const masters = await res.json();
            const container = document.getElementById('masterTodos');
            
            // [ìˆ˜ì •] data-duration ì†ì„±ì„ ì¶”ê°€í•˜ì—¬ ë“œë˜ê·¸ ì‹œ ì°¸ì¡°í•  ìˆ˜ ìˆê²Œ í•¨
            container.innerHTML = masters.map(m => `
                <div class="todo-item" 
                    style="background: ${m.color};" 
                    data-id="${m.id}" 
                    data-duration="${m.duration || 1}"> 
                    ${m.title}
                    <span class="btn-del-master" onclick="deleteMaster(event, ${m.id})">âŒ</span>
                </div>
            `).join('');

            // ì—„ë§ˆ ì°½ê³  Sortable (ë³µì œ ëª¨ë“œ)
            new Sortable(container, {
                group: { name: 'shared', pull: 'clone', put: true },
                sort: false, animation: 150,
                delay: 100, // [ì¶”ê°€] ëª¨ë°”ì¼ í„°ì¹˜ ì‹œ ë“œë˜ê·¸ ì§€ì—°
                delayOnTouchOnly: true,
                onStart: () => toggleTrash(true), // [ì¶”ê°€]
                onEnd: () => toggleTrash(false),   // [ì¶”ê°€]
                onAdd: async function (evt) {
                    const item = evt.item;
                    const planId = item.dataset.planId;
                    if (planId) {
                        // ìŠ¬ë¡¯ì—ì„œ ë³´ë¬¼ì°½ê³ ë¡œ ë“œë˜ê·¸ ì‹œ ì‚­ì œ ì²˜ë¦¬
                        showConfirm("ì´ í•  ì¼ì„ ì‚­ì œí• ê¹Œìš”?", async () => {
                            await fetch(`${API_BASE}/plans/${planId}`, { method: 'DELETE' });
                            item.remove(); 
                        }, () => {
                            item.remove(); // ë“œë¡­ëœ ì•„ì´í…œ ì œê±°
                            renderSchedule(); // ì›ë˜ ìœ„ì¹˜ ë³µêµ¬
                        });
                    } else {
                        item.remove();
                    }
                }
            });
        } catch(err) { console.error(err); }
    }

    // [ì¶”ê°€] íœ´ì§€í†µ ê¸°ëŠ¥ ì´ˆê¸°í™”
    function initTrashCan() {
        const trashEl = document.getElementById('trashCan');
        new Sortable(trashEl, {
            group: 'shared',
            onAdd: async function (evt) {
                const item = evt.item;
                const planId = item.dataset.planId;
                const masterId = item.dataset.id;

                showConfirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", async () => {
                    if (planId) {
                        // ì¼ì • ì‚­ì œ
                        await fetch(`${API_BASE}/plans/${planId}`, { method: 'DELETE' });
                    } else if (masterId) {
                        // ë³´ë¬¼ì°½ê³  ì•„ì´í…œ ì‚­ì œ
                        await fetch(`${API_BASE}/masters/${masterId}`, { method: 'DELETE' });
                        loadMasters(); 
                    }
                    item.remove(); 
                }, () => {
                    // ì·¨ì†Œ ì‹œ ë³µêµ¬
                    renderSchedule();
                    loadMasters();
                });
            }
        });
    }

    function toggleTrash(show) {
        const el = document.getElementById('trashCan');
        if(show) el.classList.add('active');
        else el.classList.remove('active');
    }

        // ëª¨ë°”ì¼ ë©”ë‰´ ì œì–´ ë³€ìˆ˜
    let selectedPlanElement = null;

    // [ê°œì„ ] í”Œëœ ë¡œë“œ ì‹œ ë Œë”ë§ ë¡œì§
    async function loadPlans(startDate, endDate) {
        const res = await fetch(`${API_BASE}/plans?startDate=${startDate}&endDate=${endDate}`);
        const plans = await res.json();
        plans.forEach(p => {
            const selector = `.child-slot[data-date="${p.planDate}"][data-child="${p.childName}"][data-time="${p.timeSlot}"] .slot-inner`;
            const slot = document.querySelector(selector);
            
            if(slot) {
                const div = document.createElement('div');
                div.className = 'todo-item';
                div.style.background = p.todoMaster.color;
                div.style.height = (p.duration * 50 - 4) + "px"; // 30ë¶„ë‹¹ 50px ê³„ì‚°
                div.style.position = "absolute"; // ê²¹ì¹¨ í—ˆìš©ì„ ìœ„í•´ absolute
                div.style.top = "2px";
                
                const textSpan = document.createElement('span');
                textSpan.className = 'todo-text';
                textSpan.innerText = (p.isCompleted ? "â˜… " : "") + p.todoMaster.title;
                div.appendChild(textSpan);

                div.dataset.planId = p.id;
                div.dataset.duration = p.duration;

                // [ì¶”ê°€] ì‚­ì œ ë²„íŠ¼(X) ìƒì„±
                const delBtn = document.createElement('div');
                delBtn.className = 'btn-delete-plan';
                delBtn.innerText = 'âœ•';
                delBtn.onclick = (e) => {
                    e.stopPropagation(); // ë¶€ëª¨ í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
                    deletePlan(p.id, div);
                };
                div.appendChild(delBtn);

                // [í•µì‹¬] ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ (ì—„ë§ˆëª¨ë“œ ë³„/ì‚­ì œ ë©”ë‰´)
                div.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    if (isMomMode) {
                        showMobileMenu(e, p.id, p.isCompleted, div);
                    } else {
                        // ì¼ë°˜ ëª¨ë“œ í„°ì¹˜ ì‚­ì œ ì œê±° (ë“œë˜ê·¸ë¡œ ì‚­ì œ)
                    }
                });

                // [ì¶”ê°€] PC í´ë¦­ ì´ë²¤íŠ¸ (ì—„ë§ˆëª¨ë“œ ë³„ ì£¼ê¸°)
                div.addEventListener('click', (e) => {
                    if (isMomMode) {
                        toggleComplete(p.id, !p.isCompleted);
                    }
                });

                slot.appendChild(div);
            }
        });

        // [ì¶”ê°€] ê°™ì€ ì‹œê°„ëŒ€ ê²¹ì¹˜ëŠ” ì¼ì • ë„ˆë¹„/ìœ„ì¹˜ ì¡°ì •
        document.querySelectorAll('.slot-inner').forEach(slot => {
            const items = slot.querySelectorAll('.todo-item');
            if (items.length > 0) {
                const width = 100 / items.length;
                items.forEach((item, idx) => {
                    item.style.width = `${width}%`;
                    item.style.left = `${width * idx}%`;
                });
            }
        });
        updateSlotStates(); // [ì¶”ê°€] ìƒíƒœ ì ìš©
    }

    // [ì¶”ê°€] ì•„ì´ ì´ë¦„ í´ë¦­ ì‹œ í•´ë‹¹ ì•„ì´ ìŠ¬ë¡¯ë§Œ í™œì„±í™”
    function setActiveChild(name) {
        if (activeChild === name) {
            activeChild = null; // í† ê¸€ í•´ì œ (ì „ì²´ í™œì„±í™”)
        } else {
            activeChild = name;
        }
        updateSlotStates();
    }

    function updateSlotStates() {
        const isSelected = (name) => !activeChild || activeChild === name;

        // 1. í—¤ë” ìŠ¤íƒ€ì¼ (íˆ¬ëª…ë„ ì¡°ì ˆ)
        document.querySelectorAll('.child-header').forEach(th => {
            th.style.opacity = isSelected(th.innerText.trim()) ? '1' : '0.2';
        });

        // 2. ìŠ¬ë¡¯ ë¹„í™œì„±í™” (í´ë¦­/ë“œë¡­ ë°©ì§€)
        document.querySelectorAll('.child-slot').forEach(td => {
            const enabled = isSelected(td.dataset.child);
            td.style.opacity = enabled ? '1' : '0.2';
            td.style.pointerEvents = enabled ? 'auto' : 'none';
        });
    }

    // ëª¨ë°”ì¼ìš© í€µ ë©”ë‰´ ë„ìš°ê¸°
    function showMobileMenu(e, planId, currentStatus, element) {
        // ê¸°ì¡´ ë©”ë‰´ ìˆìœ¼ë©´ ì œê±°
        const oldMenu = document.getElementById('mobileMenu');
        if(oldMenu) oldMenu.remove();

        const menu = document.createElement('div');
        menu.id = 'mobileMenu';
        menu.className = 'mobile-menu';
        menu.style.display = 'flex';
        menu.style.left = '50%';
        menu.style.top = '50%';
        menu.style.transform = 'translate(-50%, -50%)';

        menu.innerHTML = `
            <button onclick="handleToggleComplete(${planId}, ${!currentStatus})">
                ${currentStatus ? 'â˜† ë³„ ë¹¼ê¸°' : 'â˜… ë³„ ì£¼ê¸°'}
            </button>
            <button class="del" onclick="handleDeletePlan(${planId})">ğŸ—‘ï¸ ì‚­ì œí•˜ê¸°</button>
            <button onclick="this.parentElement.remove()">ì·¨ì†Œ</button>
        `;
        document.body.appendChild(menu);
        selectedPlanElement = element;
    }

    // ë©”ë‰´ í•¸ë“¤ëŸ¬
    async function handleToggleComplete(id, status) {
        await toggleComplete(id, status);
        document.getElementById('mobileMenu').remove();
    }

    async function handleDeletePlan(id) {
        showConfirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?", async () => {
            await fetch(`${API_BASE}/plans/${id}`, { method: 'DELETE' });
            selectedPlanElement.remove();
            document.getElementById('mobileMenu').remove();
        });
    }


    // ì¼ì • ì €ì¥ API
    async function savePlan(masterId, child, date, time, duration) {
        try {
            const res = await fetch(`${API_BASE}/plans`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    todoMasterId: masterId, 
                    childName: child, 
                    planDate: date, 
                    timeSlot: time,
                    duration: duration // ëª‡ ì¹¸(30ë¶„ ë‹¨ìœ„)ì„ ì°¨ì§€í•˜ëŠ”ì§€ ì „ì†¡
                })
            });
            const data = await res.json();
            return data;
        } catch(err) {
            showToast("ì €ì¥ ì‹¤íŒ¨!");
            return null;
        }
    }

    // [ì¶”ê°€] ì¼ì • ìˆ˜ì • API (ì´ë™ ì‹œ)
    async function updatePlan(planId, date, time) {
        try {
            const res = await fetch(`${API_BASE}/plans/${planId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ planDate: date, timeSlot: time })
            });
            if (!res.ok) throw new Error('Update failed');
            return true;
        } catch(err) {
            console.error(err);
            return false;
        }
    }

    // [ì¶”ê°€ ê¸°ëŠ¥] ì¼ì • ì‚­ì œ API (ë”ë¸” í´ë¦­ ì‹œ)
    async function deletePlan(planId, element) {
        showConfirm('ì´ í•  ì¼ì„ ì‚­ì œí• ê¹Œìš”?', async () => {
            await fetch(`${API_BASE}/plans/${planId}`, { method: 'DELETE' });
            element.remove();
        });
    }

    // [ì¶”ê°€] ë§ˆìŠ¤í„° í•  ì¼ ì‚­ì œ (ë³´ë¬¼ì°½ê³ ì—ì„œ ì œê±°, ê³¼ê±° ê¸°ë¡ì€ ìœ ì§€)
    async function deleteMaster(event, id) {
        event.stopPropagation(); // ë“œë˜ê·¸ ë°©ì§€
        showConfirm("ë³´ë¬¼ì°½ê³ ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì´ë¯¸ ë°°ì¹˜ëœ ì¼ì •ì€ ìœ ì§€ë©ë‹ˆë‹¤)", async () => {
            await fetch(`${API_BASE}/masters/${id}`, { method: 'DELETE' });
            loadMasters(); // ëª©ë¡ ê°±ì‹ 
        });
    }

    // [ì¶”ê°€] ì—„ë§ˆ ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ í† ê¸€
    function toggleMomLogin() {
        if (isMomMode) {
            localStorage.removeItem('mom_access');
            isMomMode = false;
            showToast("ì—„ë§ˆ ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            showPrompt("ì—„ë§ˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:", (pw) => {
                if (!pw) return;
                if (pw === '0627') {
                    localStorage.setItem('mom_access', 'granted');
                    isMomMode = true;
                    showToast("ì—„ë§ˆ ë¡œê·¸ì¸ ì„±ê³µ!");
                } else {
                    showToast("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                }
                updateMomBtnUI();
            });
            return; // ë¹„ë™ê¸° ì²˜ë¦¬ë˜ë¯€ë¡œ UI ì—…ë°ì´íŠ¸ëŠ” ì½œë°± ë‚´ë¶€ ë˜ëŠ” ë³„ë„ ì²˜ë¦¬
        }
        updateMomBtnUI();
    }

    function checkMomMode() {
        isMomMode = localStorage.getItem('mom_access') === 'granted';
        updateMomBtnUI();
    }

    function updateMomBtnUI() {
        const btn = document.getElementById('momBtn');
        if(isMomMode) {
            btn.innerText = "ğŸ”’OUT";
            btn.style.background = "#fab1a0"; 
        } else {
            btn.innerText = "â­ë³„";
            btn.style.background = "#f1c40f"; 
        }
    }

    // [ì¶”ê°€] í•  ì¼ ì™„ë£Œ(ë³„) í† ê¸€ API í˜¸ì¶œ
    async function toggleComplete(planId, newState) {
        await fetch(`${API_BASE}/plans/${planId}/complete`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ isCompleted: newState })
        });
        renderSchedule(); // í™”ë©´ ê°±ì‹ 
    }

    // [ì¶”ê°€] ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
    function downloadScheduleExcel() {
        const wb = XLSX.utils.book_new();
        const data = [];
        const columns = document.querySelectorAll('.day-column');
        
        if (columns.length === 0) return;

        // 1. í—¤ë” ìƒì„± (ë‚ ì§œ ë° í•­ëª©)
        const headerRow1 = []; // ë‚ ì§œ í–‰
        const headerRow2 = []; // í•­ëª© í–‰ (ì‹œê°„, í•˜ëŒ, ì›€ì°¬, íƒœë‘)
        const colWidths = [];
        const merges = [];

        columns.forEach((col, idx) => {
            const dateText = col.querySelector('h3').innerText; // ì˜ˆ: "5ì›” 20ì¼"
            
            // ë‚ ì§œ í—¤ë” (4ì¹¸ ì°¨ì§€)
            headerRow1.push(dateText, "", "", "");
            merges.push({ s: {r:0, c:idx*4}, e: {r:0, c:idx*4+3} }); // ì…€ ë³‘í•© ì„¤ì •

            // í•­ëª© í—¤ë”
            headerRow2.push("ì‹œê°„", "í•˜ëŒ", "ì›€ì°¬", "íƒœë‘");
            colWidths.push({wch: 12}, {wch: 20}, {wch: 20}, {wch: 20});
        });

        data.push(headerRow1);
        data.push(headerRow2);

        // 2. ë°ì´í„° í–‰ ìƒì„± (ì‹œê°„ëŒ€ë³„ë¡œ ëª¨ë“  ë‚ ì§œì˜ ë°ì´í„° ìˆ˜ì§‘)
        // ì²« ë²ˆì§¸ ì»¬ëŸ¼ì˜ í–‰ ê°œìˆ˜(ì‹œê°„ ìŠ¬ë¡¯ ìˆ˜)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°˜ë³µ
        const rowCount = columns[0].querySelectorAll('tbody tr').length;
        
        // [ì¶”ê°€] ì§„í–‰ ì¤‘ì¸ ê¸´ í•  ì¼ ì¶”ì ìš© (Key: ì—´ ì¸ë±ìŠ¤, Value: ë‚¨ì€ ì‹œê°„)
        const ongoingTasks = {}; 
        
        for (let i = 0; i < rowCount; i++) {
            const rowData = [];
            
            columns.forEach((col, colIdx) => {
                const tr = col.querySelectorAll('tbody tr')[i];
                const slots = tr.querySelectorAll('.child-slot');
                // ì‹œê°„ í…ìŠ¤íŠ¸ (í™”ë©´ì— ë³´ì´ëŠ” ê°’ ì‚¬ìš©)
                const timeText = tr.querySelector('.time-label').innerText;
                
                rowData.push(timeText);
                
                // í•˜ëŒ, ì›€ì°¬, íƒœë‘ ìˆœì„œëŒ€ë¡œ í•  ì¼ í…ìŠ¤íŠ¸ ì¶”ì¶œ
                slots.forEach((slot, slotIdx) => {
                    // í˜„ì¬ ì—‘ì…€ ìƒì˜ ì—´ ì¸ë±ìŠ¤ (ì‹œê°„ ì—´ í¬í•¨: ë‚ ì§œì¸ë±ìŠ¤*4 + 1(ì‹œê°„) + ìŠ¬ë¡¯ì¸ë±ìŠ¤)
                    const currentExcelColIdx = colIdx * 4 + 1 + slotIdx;

                    if (ongoingTasks[currentExcelColIdx] && ongoingTasks[currentExcelColIdx] > 0) {
                        rowData.push(""); // ë³‘í•©ë  ê²ƒì´ë¯€ë¡œ ë¹ˆ ê°’
                        ongoingTasks[currentExcelColIdx]--;
                    } else {
                        const items = Array.from(slot.querySelectorAll('.todo-item'));
                        if (items.length > 0) {
                            const texts = items.map(item => item.innerText.replace('âŒ', '').trim());
                            rowData.push(texts.join(', '));

                            // ê°€ì¥ ê¸´ duration ì°¾ê¸°
                            let maxDuration = 1;
                            items.forEach(item => {
                                const d = parseInt(item.dataset.duration || "1", 10);
                                if (d > maxDuration) maxDuration = d;
                            });

                            if (maxDuration > 1) {
                                ongoingTasks[currentExcelColIdx] = maxDuration - 1;
                                merges.push({
                                    s: { r: i + 2, c: currentExcelColIdx },
                                    e: { r: i + 2 + maxDuration - 1, c: currentExcelColIdx }
                                });
                            }
                        } else {
                            rowData.push("");
                        }
                    }
                });
            });
            data.push(rowData);
        }

        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
        ws['!cols'] = colWidths;
        // ë‚ ì§œ í—¤ë” ë³‘í•© ì ìš©
        ws['!merges'] = merges;

        XLSX.utils.book_append_sheet(wb, ws, "ì‹œê°„í‘œ");
        XLSX.writeFile(wb, `ì•„ì´ë“¤_ì‹œê°„í‘œ_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // =========================================
    // 4. íŒì—…ì°½ ê´€ë ¨ (ì—„ë§ˆê°€ í•  ì¼ ì¶”ê°€)
    // =========================================
    async function saveNewMaster() {
        const title = document.getElementById('newTodoTitle').value;
        const color = document.getElementById('selectedColor').value;
        const duration = document.getElementById('newTodoDuration').value;
        if (!title) return showToast("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");

        await fetch(`${API_BASE}/masters`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, color , duration})
        });
        
        closeModal();
        loadMasters();
        document.getElementById('newTodoTitle').value = '';
    }

    function openModal() { document.getElementById('todoModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('todoModal').style.display = 'none'; }
    function selectColor(el) {
        document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('selectedColor').value = el.style.backgroundColor; 
    }
</script>
</body>
</html>