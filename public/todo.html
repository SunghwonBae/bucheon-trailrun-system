<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì•„ì´ë“¤ ì‹œê°„ íƒí—˜ëŒ€</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --bg-color: #f0f9ff; --border-bold: 2px solid #3498db; --border-dot: 1px dashed #bdc3c7; }
        body { font-family: 'Jua', sans-serif; background: var(--bg-color); margin: 0; padding: 20px; }
        
        /* ì—„ë§ˆì˜ Todo ì°½ê³  */
        .todo-storage { 
            background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 0 #ddd;
            display: flex; gap: 10px; margin-bottom: 30px; border: 3px solid #3498db;
        }
        .todo-item { 
            padding: 10px 20px; border-radius: 15px; cursor: grab; font-weight: bold;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1); transition: transform 0.2s;
        }
        .todo-item:active { cursor: grabbing; transform: translateY(4px); }

        /* ì´í‹€ì¹˜ ì»¨í…Œì´ë„ˆ */
        .days-container { display: flex; gap: 20px; overflow-x: auto; }
        .day-column { flex: 1; min-width: 400px; background: white; border-radius: 20px; padding: 15px; }
        
        /* ì‹œê°„í‘œ í…Œì´ë¸” */
        .schedule-table { width: 100%; border-collapse: collapse; }
        .time-row { height: 50px; }
        .time-row.on-hour { border-top: var(--border-bold); } /* ì •ì‹œ ì‹¤ì„  */
        .time-row.half-hour { border-top: var(--border-dot); } /* 30ë¶„ ì ì„  */
        
        .time-label { width: 60px; text-align: center; font-size: 0.9rem; color: #7f8c8d; }
        .child-slot { width: 30%; border-left: 1px solid #eee; position: relative; }
        .slot-inner { min-height: 40px; display: flex; flex-wrap: wrap; gap: 4px; padding: 5px; }
        
        .child-header { text-align: center; font-size: 1.2rem; padding: 10px 0; background: #3498db; color: white; border-radius: 10px 10px 0 0; }
        
        .nav-btns { margin-bottom: 10px; display: flex; justify-content: space-between; }
        button { padding: 10px 20px; border-radius: 30px; border: none; background: #e67e22; color: white; cursor: pointer; font-size: 1rem; }
    </style>
</head>
<body>

    <div class="todo-storage" id="masterTodos">
        <div class="todo-item" style="background: #ff7675;" data-id="1">ğŸ“š ë…ì„œ</div>
        <div class="todo-item" style="background: #74b9ff;" data-id="2">ğŸ‡¬ğŸ‡§ ì˜ì–´</div>
        <div class="todo-item" style="background: #55efc4;" data-id="3">ğŸ ê°„ì‹</div>
        <div class="todo-item" style="background: #fab1a0;" data-id="4">ğŸ¹ í”¼ì•„ë…¸</div>
    </div>

    <div class="nav-btns">
        <button onclick="prevDays()">â¬…ï¸ ì´ì „ ì´í‹€</button>
        <h2 id="dateRange">5ì›” 20ì¼ - 5ì›” 21ì¼</h2>
        <button onclick="nextDays()">ë‹¤ìŒ ì´í‹€ â¡ï¸</button>
    </div>

    <div class="days-container" id="scheduleBoard">
        <div class="day-column">
            <h3 align="center">ì˜¤ëŠ˜ (5ì›” 20ì¼)</h3>
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th></th>
                        <th class="child-header" style="background:#ff9f43">í•˜ëŒ</th>
                        <th class="child-header" style="background:#54a0ff">ì›€ì°¬</th>
                        <th class="child-header" style="background:#5f27cd">íƒœë‘</th>
                    </tr>
                </thead>
                <tbody id="timeGrid">
                    </tbody>
            </table>
        </div>
        </div>

<script>
    // [ìˆ˜ì • 1] API ê²½ë¡œ ìˆ˜ì • (/api/todo/...)
    const API_BASE = '/api/todo';

    // ì‹œê°„ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
    function initGrid() {
        const grid = document.getElementById('timeGrid');
        // ... (ê¸°ì¡´ ì‹œê°„ í–‰ ìƒì„± ë¡œì§ ìœ ì§€) ... 
        
        // 8ì‹œ~22ì‹œ í–‰ ìƒì„± ì½”ë“œ (ê¸°ì¡´ê³¼ ë™ì¼)
        for(let h=8; h<=22; h++) {
            ['00', '30'].forEach(m => {
                if(h === 22 && m === '30') return;
                const isHour = m === '00';
                const time = `${String(h).padStart(2, '0')}:${m}`;
                const row = `<tr class="time-row ${isHour ? 'on-hour' : 'half-hour'}">
                    <td class="time-label">${isHour ? time : ''}</td>
                    <td class="child-slot" data-child="í•˜ëŒ" data-time="${time}"><div class="slot-inner"></div></td>
                    <td class="child-slot" data-child="ì›€ì°¬" data-time="${time}"><div class="slot-inner"></div></td>
                    <td class="child-slot" data-child="íƒœë‘" data-time="${time}"><div class="slot-inner"></div></td>
                </tr>`;
                grid.insertAdjacentHTML('beforeend', row);
            });
        }
        
        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ í˜¸ì¶œ
        loadMasters();
        loadPlans();
    }

    // [ì¶”ê°€] ì—„ë§ˆê°€ ë§Œë“  Todo ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadMasters() {
        const res = await fetch(`${API_BASE}/masters`);
        const masters = await res.json();
        const container = document.getElementById('masterTodos');
        
        container.innerHTML = masters.map(m => 
            `<div class="todo-item" style="background: ${m.color};" data-id="${m.id}">${m.title}</div>`
        ).join('');

        // Sortable ì—°ê²° (ì—„ë§ˆ ì°½ê³ )
        new Sortable(container, {
            group: { name: 'shared', pull: 'clone', put: false },
            sort: false, animation: 150
        });
    }

    // [ì¶”ê°€] ë°°ì¹˜ëœ ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadPlans() {
        // ë‚ ì§œëŠ” ì˜ˆì‹œë¡œ ê³ ì • (ì‹¤ì œë¡œëŠ” date input ê°’ ì‚¬ìš©)
        const date = "2024-05-20"; 
        const res = await fetch(`${API_BASE}/plans?startDate=${date}&endDate=${date}`);
        const plans = await res.json();

        plans.forEach(p => {
            // í•´ë‹¹ ìœ„ì¹˜(ì‹œê°„+ì•„ì´) ì°¾ê¸°
            const slot = document.querySelector(`.child-slot[data-child="${p.childName}"][data-time="${p.timeSlot}"] .slot-inner`);
            if(slot) {
                const div = document.createElement('div');
                div.className = 'todo-item';
                div.style.background = p.todoMaster.color;
                div.innerText = p.todoMaster.title;
                div.dataset.planId = p.id;
                slot.appendChild(div);
            }
        });

        // ëª¨ë“  ì‹œê°„ ìŠ¬ë¡¯ì— Sortable ê¸°ëŠ¥ ë¶€ì—¬
        document.querySelectorAll('.slot-inner').forEach(slot => {
            new Sortable(slot, {
                group: 'shared', animation: 150,
                onAdd: async function (evt) {
                    const item = evt.item;
                    const masterId = item.dataset.id;
                    // slot-innerì˜ ë¶€ëª¨ tdì—ì„œ ë°ì´í„° ì½ê¸°
                    const parentTd = evt.to.parentElement; 
                    const child = parentTd.dataset.child;
                    const time = parentTd.dataset.time;
                    
                    const saved = await savePlan(masterId, child, "2024-05-20", time);
                    item.dataset.planId = saved.id;
                }
            });
        });
    }

    // ì¼ì • ì €ì¥ API í˜¸ì¶œ
    async function savePlan(masterId, child, date, time) {
        const response = await fetch(`${API_BASE}/plans`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ todoMasterId: masterId, childName: child, planDate: date, timeSlot: time })
        });
        return await response.json();
    }

    initGrid();
</script>
</body>
</html>