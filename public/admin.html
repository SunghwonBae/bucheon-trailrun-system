<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì - ì„ ìˆ˜ ê´€ë¦¬</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { cursor: pointer; background: #f8f9fa; border: 1px solid #ddd; padding: 10px; }
        th:hover { background: #e9ecef; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        input[type="text"], input[type="number"] { width: 90%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .toast { position: fixed; top: 20px; right: 20px; background: #2ecc71; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; }
        .btn-reset { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .btn-excel { background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="toast" class="toast">ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
    <h1>ğŸƒ ì„ ìˆ˜ ì •ë³´ ê´€ë¦¬</h1>

    <div class="controls">
        <button class="btn-excel" onclick="downloadExcel()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        <button onclick="downloadTemplate()" style="background:#34495e; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">ğŸ“¥ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
    
        <div style="border-left: 2px solid #ccc; padding-left: 15px; display: flex; align-items: center; gap: 10px;">
            <label for="excelFile" style="font-weight: bold; cursor: pointer; background: #9b59b6; color: white; padding: 8px 15px; border-radius: 4px;">íŒŒì¼ ì„ íƒ</label>
            <input type="file" id="excelFile" accept=".xlsx, .xls" style="display: none;" onchange="uploadExcel(this)">
            <span id="fileName" style="font-size: 0.85rem; color: #666;">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
        </div>

        <button class="btn-reset" onclick="resetAllRecords()">ğŸ”„ ëª¨ë“  ê¸°ë¡ ì´ˆê¸°í™”</button>
        <button onclick="location.href='/'">ğŸ  ì „ê´‘íŒìœ¼ë¡œ</button>
        <button onclick="location.href='/certificate.html'" style="background:#f39c12; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">ğŸ† ìƒì¥ ì¶œë ¥ í™”ë©´</button>
    </div>

    <table id="runnerTable">
        <thead>
            <tr>
                <th onclick="sortTable(0)">ë°°ë²ˆ â†•</th>
                <th onclick="sortTable(1)">ì´ë¦„ â†•</th>
                <th onclick="sortTable(2)">ì„±ë³„ â†•</th>
                <th onclick="sortTable(3)">ì¶œìƒë…„ë„ â†•</th>
                <th onclick="sortTable(4)">ì†Œì† â†•</th>
                <th onclick="sortTable(5)">ì—°ë½ì²˜ â†•</th>
                <th onclick="sortTable(6)">ì…ê¸ˆ â†•</th>
                <th onclick="sortTable(7)">ê¸°ë¡ â†•</th>
                <th onclick="sortTable(8)">ì¸ì‡„ìˆ˜ â†•</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody id="runnerList"></tbody>
    </table>

    <script>

        // 1. ì§ì ‘ ì ‘ì† ì°¨ë‹¨ ë¡œì§ (í˜ì´ì§€ ìµœìƒë‹¨)
        if (localStorage.getItem('admin_access') !== 'granted') {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ì—ì„œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            location.href = '/';
        }

        // ì‹œê°„ í¬ë§· í•¨ìˆ˜ (HH:mm:ss)
        function formatTime(dateStr, startTimeStr) {
            if (!dateStr || !startTimeStr) return "-";
            const diff = new Date(dateStr) - new Date(startTimeStr);
            if (diff < 0) return "-";
            return new Date(diff).toISOString().substr(11, 8);
        }

        let runnersData = [];

        // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function fetchRunners() {
            const res = await fetch('/api/runners');
            runnersData = await res.json();
            renderTable(runnersData);
        }

        function renderTable(data) {
            const tbody = document.getElementById('runnerList');
            tbody.innerHTML = '';
            data.forEach(r => {
                const recordStr = formatTime(r.finishTime, r.startTime);
                const row = `<tr>
                    <td><input type="text" value="${r.bibNumber}" onchange="updateField(${r.id}, 'bibNumber', this.value)"></td>
                    <td><input type="text" value="${r.name || ''}" onchange="updateField(${r.id}, 'name', this.value)"></td>
                    <td><input type="text" value="${r.gender || ''}" onchange="updateField(${r.id}, 'gender', this.value)"></td>
                    <td><input type="number" value="${r.birthYear || ''}" onchange="updateField(${r.id}, 'birthYear', this.value)"></td>
                    <td><input type="text" value="${r.affiliation || ''}" onchange="updateField(${r.id}, 'affiliation', this.value)"></td>
                    <td><input type="text" value="${r.phone || ''}" onchange="updateField(${r.id}, 'phone', this.value)"></td>

                    <td>
                        <select onchange="updateField(${r.id}, 'paymentStatus', this.value)" 
                                style="background: ${r.paymentStatus==='Y'?'#d4edda':r.paymentStatus==='F'?'#e2e3e5':'#f8d7da'}">
                            <option value="Y" ${r.paymentStatus==='Y'?'selected':''}>Y (í™•ì¸)</option>
                            <option value="N" ${r.paymentStatus==='N'?'selected':''}>N (ë¯¸ì…ê¸ˆ)</option>
                            <option value="F" ${r.paymentStatus==='F'?'selected':''}>F (ë¬´ë£Œ)</option>
                        </select>
                    </td>
                    <td>${recordStr}</td> 
                    <td>
                        <span id="print-count-${r.id}">${r.printCount}</span>íšŒ
                        ${r.finishTime ? 
                            `<button onclick="printCertificate(${r.id}, '${r.bibNumber}')">ğŸ–¨ï¸ ì¸ì‡„</button>` : 
                            `<span style="color:#ccc; font-size:0.8rem;">ê³¨ì¸ì „</span>`
                        }
                    </td>
                    <td><button onclick="deleteRunner(${r.id})" style="color:red; border:none; background:none; cursor:pointer;">âŒ</button></td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        // ì¸ë¼ì¸ ìˆ˜ì • í•¨ìˆ˜
        async function updateField(id, field, value) {
            const body = {};
            body[field] = field === 'birthYear' ? Number(value) : value;
            
            await fetch(`/api/runners/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            showToast();
        }

        // ê¸°ë¡ì¦ ì¸ì‡„ ë° ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        async function printCertificate(id, bib) {
            // 1. ì¹´ìš´íŠ¸ ì¦ê°€ ìš”ì²­
            const res = await fetch(`/api/runners/${id}/print`, { method: 'POST' });
            const result = await res.json();
            
            // 2. í™”ë©´ì˜ ì¹´ìš´íŠ¸ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            document.getElementById(`print-count-${id}`).innerText = result.printCount;

            // 3. ê¸°ë¡ì¦ ì¸ì‡„ íŒì—… ì°½ ì—´ê¸° (Silent Print ëª¨ë“œ ì‚¬ìš© ê¶Œì¥)
            const printWindow = window.open(`/certificate_single.html?bib=${bib}`, '_blank');
        }

        function showToast() {
            const toast = document.getElementById('toast');
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2000);
        }

        // ê¸°ë¡ ì´ˆê¸°í™” (3ê°€ì§€ ì¹¼ëŸ¼ í†µí•© ì‚­ì œ)
        async function resetAllRecords() {
            if(confirm("ëª¨ë“  ì„ ìˆ˜ì˜ ì¶œë°œ, ë„ì°©(ìˆ˜ë™/ìë™) ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await fetch('/api/runners/reset-records', { method: 'POST' });
                alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                fetchRunners();
            }
        }

        // 1. ì—…ë¡œë“œìš© í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadTemplate() {
            const templateData = [
                { bibNumber: "101", name: "í™ê¸¸ë™", gender: "ë‚¨", birthYear: 1980, affiliation: "ë¶€ì²œíŠ¸ë¼ì´", phone: "010-1234-5678" }
            ];
            const worksheet = XLSX.utils.json_to_sheet(templateData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
            XLSX.writeFile(workbook, "runner_template.xlsx");
        }

        // 2. ì—‘ì…€ íŒŒì¼ ì½ê¸° ë° ì„œë²„ ì „ì†¡
        function uploadExcel(input) {
            const file = input.files[0];
            if (!file) return;
            
            document.getElementById('fileName').innerText = file.name;
            const reader = new FileReader();

            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                if (confirm(`${json.length}ëª…ì˜ ë°ì´í„°ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë°°ë²ˆ ì¤‘ë³µ ì‹œ ê¸°ì¡´ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.)`)) {
                    try {
                        const response = await fetch('/api/runners/bulk', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(json)
                        });
                        const result = await response.json();
                        alert(result.message);
                        fetchRunners(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    } catch (err) {
                        alert("ì—…ë¡œë“œ ì‹¤íŒ¨: ë°ì´í„° í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    }
                }
                input.value = ''; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            };
            reader.readAsArrayBuffer(file);
        }

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        function downloadExcel() {
            const exportData = runnersData.map(r => ({
                "ë°°ë²ˆ": r.bibNumber,
                "ì´ë¦„": r.name,
                "ì„±ë³„": r.gender,
                "ê¸°ë¡": formatTime(r.finishTime, r.startTime), // ì—‘ì…€ì—ë„ ì‹œ:ë¶„:ì´ˆ í¬í•¨
                "ì…ê¸ˆ": r.paymentStatus,
                "ì¸ì‡„ìˆ˜": r.printCount,
                "ì—°ë½ì²˜": r.phone
            }));
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "ì„ ìˆ˜ëª…ë‹¨");
            XLSX.writeFile(workbook, "trail_runners_final.xlsx");
        }

        // í…Œì´ë¸” ì •ë ¬
        let sortOrder = true;
        function sortTable(n) {
            sortOrder = !sortOrder;
            const sorted = [...runnersData].sort((a, b) => {
                const fields = ['bibNumber', 'name', 'gender', 'birthYear', 'affiliation', 'phone'];
                const valA = a[fields[n]] || '';
                const valB = b[fields[n]] || '';
                return sortOrder ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
            });
            renderTable(sorted);
        }

        fetchRunners();
    </script>
</body>
</html>