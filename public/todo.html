<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì•„ì´ë“¤ ì‹œê°„ íƒí—˜ëŒ€</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg-color: #f0f9ff; --border-bold: 2px solid #3498db; --border-dot: 1px dashed #bdc3c7; }
        body { font-family: 'Jua', sans-serif; background: var(--bg-color); margin: 0; padding: 20px; }
        
        /* ì—„ë§ˆì˜ Todo ì°½ê³  */
        .todo-storage { 
            background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 0 #ddd;
            display: flex; gap: 10px; margin-bottom: 30px; border: 3px solid #3498db;
        }
        .todo-item { 
            padding: 10px 20px; border-radius: 15px; cursor: grab; font-weight: bold;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1); transition: transform 0.2s;
        }
        .todo-item:active { cursor: grabbing; transform: translateY(4px); }
        
        /* ë§ˆìŠ¤í„° ì‚­ì œ ë²„íŠ¼ */
        .btn-del-master {
            margin-left: 5px; cursor: pointer; font-size: 0.8rem; opacity: 0.6;
        }
        .btn-del-master:hover { opacity: 1; color: red; }

        /* ì´í‹€ì¹˜ ì»¨í…Œì´ë„ˆ */
        .days-container { display: flex; gap: 20px; overflow-x: auto; }
        .day-column { flex: 1; min-width: 400px; background: white; border-radius: 20px; padding: 15px; }
        
        /* ì‹œê°„í‘œ í…Œì´ë¸” */
        .schedule-table { width: 100%; border-collapse: collapse; }
        .time-row { height: 50px; }
        .time-row.on-hour { border-top: var(--border-bold); } /* ì •ì‹œ ì‹¤ì„  */
        .time-row.half-hour { border-top: var(--border-dot); } /* 30ë¶„ ì ì„  */
        
        .time-label { width: 60px; text-align: center; font-size: 0.9rem; color: #7f8c8d; }
        .child-slot { width: 30%; border-left: 1px solid #eee; position: relative; }
        .slot-inner { min-height: 40px; display: flex; flex-wrap: wrap; gap: 4px; padding: 5px; }
        
        .child-header { text-align: center; font-size: 1.2rem; padding: 10px 0; background: #3498db; color: white; border-radius: 10px 10px 0 0; }
        
        .nav-btns { margin-bottom: 10px; display: flex; justify-content: space-between; }
        button { padding: 10px 20px; border-radius: 30px; border: none; background: #e67e22; color: white; cursor: pointer; font-size: 1rem; }

        /* ìƒë‹¨ í—¤ë” */
        .header-section { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .btn-add-todo { background: #6c5ce7; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #4834d4; transition: 0.2s; }
        .btn-add-todo:active { transform: translateY(4px); box-shadow: none; }
        .btn-excel { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #219150; transition: 0.2s; margin-right: 10px; }
        .btn-excel:active { transform: translateY(4px); box-shadow: none; }
        .btn-star { background: #f1c40f; color: #2d3436; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #f39c12; transition: 0.2s; margin-right: 10px; }
        .btn-star:active { transform: translateY(4px); box-shadow: none; }

        /* ëª¨ë‹¬ì°½(íŒì—…) ìŠ¤íƒ€ì¼ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border: 4px solid #a29bfe; }
        .input-group { margin: 15px 0; text-align: left; }
        .input-group input[type="text"] { width: 90%; padding: 10px; border: 2px solid #dfe6e9; border-radius: 10px; font-size: 1rem; }

        /* ìƒ‰ìƒ ì„ íƒê¸° */
        .color-options { display: flex; gap: 10px; margin-top: 5px; justify-content: center; }
        .color-circle { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: 0.2s; }
        .color-circle:hover { transform: scale(1.2); }
        .color-circle.selected { border-color: #2d3436; transform: scale(1.1); }
        .modal-btns { display: flex; justify-content: space-around; margin-top: 20px; }

        @media (max-width: 768px) {
            .day-column { min-width: 100%; }
        }
    </style>
</head>
<body>

    <div class="header-section">
        <h2>ğŸ’ í•  ì¼ ë³´ë¬¼ì°½ê³ </h2>
        <div>
            <button id="momBtn" onclick="toggleMomLogin()" class="btn-star">â­ ë³„í‘œì‹œí•˜ê¸°</button>
            <button onclick="downloadScheduleExcel()" class="btn-excel">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
            <button onclick="openModal()" class="btn-add-todo">â• ìƒˆ í• ì¼ ë§Œë“¤ê¸°</button>
        </div>
    </div>

    <div class="todo-storage" id="masterTodos">
        <div style="color:#aaa; padding:10px;">ë¡œë”© ì¤‘...</div>
    </div>

    <div id="todoModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>âœ¨ ìƒˆë¡œìš´ í• ì¼ ë§Œë“¤ê¸°</h3>
            <div class="input-group">
                <label>ì´ë¦„:</label>
                <input type="text" id="newTodoTitle" placeholder="ì˜ˆ: ë…ì„œ, í”¼ì•„ë…¸, ì¤„ë„˜ê¸°">
            </div>
            <div class="input-group">
                <label>ìƒ‰ìƒ:</label>
                <div class="color-options">
                    <div class="color-circle selected" style="background:#ff7675" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#74b9ff" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#55efc4" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#fab1a0" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#a29bfe" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#ffeaa7" onclick="selectColor(this)"></div>
                </div>
                <input type="hidden" id="selectedColor" value="#ff7675">
            </div>
            <div class="modal-btns">
                <button onclick="closeModal()" style="background:#95a5a6">ì·¨ì†Œ</button>
                <button onclick="saveNewMaster()" style="background:#00b894">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div class="nav-btns">
        <button onclick="moveDate(-1)">â¬…ï¸ ì´ì „</button>
        <h2 id="dateRange">ë‚ ì§œ ë¡œë”© ì¤‘...</h2>
        <button onclick="moveDate(1)">ë‹¤ìŒ â¡ï¸</button>
    </div>

    <div class="days-container" id="scheduleBoard">
        <div class="day-column">
            <h3 align="center">ì˜¤ëŠ˜ (5ì›” 20ì¼)</h3>
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th></th>
                        <th class="child-header" style="background:#ff9f43">í•˜ëŒ</th>
                        <th class="child-header" style="background:#54a0ff">ì›€ì°¬</th>
                        <th class="child-header" style="background:#5f27cd">íƒœë‘</th>
                    </tr>
                </thead>
                <tbody id="timeGrid">
                    </tbody>
            </table>
        </div>
        </div>

<script>
    const API_BASE = '/api/todo'; 
    let currentDate = new Date(); // í˜„ì¬ ê¸°ì¤€ ë‚ ì§œ
    let daysToShow = 2; // ê¸°ë³¸ê°’ (PC)
    let isMomMode = false; // ì—„ë§ˆ ë¡œê·¸ì¸ ìƒíƒœ

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', () => {
        checkMomMode(); // ì—„ë§ˆ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        updateDaysToShow();
        loadMasters();    // 1. ì—„ë§ˆì˜ í•  ì¼ ëª©ë¡ ë¡œë“œ
        renderSchedule(); // 2. ì‹œê°„í‘œ ê·¸ë¦¬ê¸° ë° ë°ì´í„° ë¡œë“œ
    });

    // í™”ë©´ í¬ê¸° ë³€ê²½ ê°ì§€
    window.addEventListener('resize', () => {
        const prevDays = daysToShow;
        updateDaysToShow();
        if (prevDays !== daysToShow) renderSchedule();
    });

    // =========================================
    // 1. ë‚ ì§œ ë° ê·¸ë¦¬ë“œ ë Œë”ë§ (í•µì‹¬ ë¡œì§)
    // =========================================

    function updateDaysToShow() {
        daysToShow = window.innerWidth <= 768 ? 1 : 2;
    }

    // ë‚ ì§œ ì´ë™ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ
    function moveDate(direction) {
        // direction: -1 (ì´ì „), 1 (ë‹¤ìŒ)
        currentDate.setDate(currentDate.getDate() + (direction * daysToShow));
        renderSchedule(); // ë‚ ì§œê°€ ë°”ë€Œì—ˆìœ¼ë‹ˆ ê·¸ë¦¬ë“œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    }

    // ë‚ ì§œ í¬ë§· í—¬í¼ (YYYY-MM-DD) - ì„œë²„ ì „ì†¡ìš©
    function getIsoDate(dateObj) {
        const offset = dateObj.getTimezoneOffset() * 60000;
        return new Date(dateObj.getTime() - offset).toISOString().split('T')[0];
    }

    // ë‚ ì§œ í¬ë§· í—¬í¼ (Mì›” Dì¼) - í™”ë©´ í‘œì‹œìš©
    function getDisplayDate(dateObj) {
        return dateObj.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' });
    }

    // ê·¸ë¦¬ë“œ ì „ì²´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    async function renderSchedule() {
        const gridContainer = document.getElementById('scheduleBoard');
        const dateRangeText = document.getElementById('dateRange');
        
        gridContainer.innerHTML = ''; // ê¸°ì¡´ í‘œ ì‚­ì œ

        // í‘œì‹œí•  ë‚ ì§œ ë°°ì—´ ìƒì„±
        const dates = [];
        for (let i = 0; i < daysToShow; i++) {
            const d = new Date(currentDate);
            d.setDate(d.getDate() + i);
            dates.push(d);
        }

        // ìƒë‹¨ ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
        if (daysToShow === 1) {
            dateRangeText.innerText = getDisplayDate(dates[0]);
        } else {
            dateRangeText.innerText = `${getDisplayDate(dates[0])} - ${getDisplayDate(dates[dates.length - 1])}`;
        }

        // ë£¨í”„ ëŒë©´ì„œ í‘œ ìƒì„±
        dates.forEach(dateObj => {
            const dateStr = getDisplayDate(dateObj);   // í™”ë©´ìš©
            const isoDate = getIsoDate(dateObj);       // ë°ì´í„°ìš© (YYYY-MM-DD)

            let html = `
                <div class="day-column" data-date="${isoDate}">
                    <h3 align="center">${dateStr}</h3>
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th class="child-header" style="background:#ff9f43">í•˜ëŒ</th>
                                <th class="child-header" style="background:#54a0ff">ì›€ì°¬</th>
                                <th class="child-header" style="background:#5f27cd">íƒœë‘</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // 08:00 ~ 22:00 ì‹œê°„ ìŠ¬ë¡¯ ìƒì„±
            for(let h=8; h<=22; h++) {
                ['00', '30'].forEach(m => {
                    if(h===22 && m==='30') return;
                    const isHour = (m === '00');
                    const time = `${String(h).padStart(2,'0')}:${m}`;
                    
                    let displayTime = '';
                    if (isHour) {
                        const ampm = h < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
                        const hour12 = h > 12 ? h - 12 : h;
                        displayTime = `${ampm} ${hour12}:${m}`;
                    }

                    html += `
                        <tr class="time-row ${isHour ? 'on-hour' : 'half-hour'}">
                            <td class="time-label">${displayTime}</td>
                            <td class="child-slot" data-child="í•˜ëŒ" data-time="${time}" data-date="${isoDate}">
                                <div class="slot-inner"></div>
                            </td>
                            <td class="child-slot" data-child="ì›€ì°¬" data-time="${time}" data-date="${isoDate}">
                                <div class="slot-inner"></div>
                            </td>
                            <td class="child-slot" data-child="íƒœë‘" data-time="${time}" data-date="${isoDate}">
                                <div class="slot-inner"></div>
                            </td>
                        </tr>
                    `;
                });
            }
            html += `</tbody></table></div>`;
            gridContainer.insertAdjacentHTML('beforeend', html);
        });

        // 3. í‘œë¥¼ ë‹¤ ê·¸ë ¸ìœ¼ë‹ˆ, ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ í™œì„±í™”
        initSortableSlots();

        // 4. ì„œë²„ì—ì„œ ì´ ë‚ ì§œë“¤ì˜ ê³„íš ë¶ˆëŸ¬ì˜¤ê¸°
        await loadPlans(getIsoDate(dates[0]), getIsoDate(dates[dates.length - 1]));
    }

    // =========================================
    // 2. ë“œë˜ê·¸ ì•¤ ë“œë¡­ (SortableJS) ì—°ê²°
    // =========================================
    function initSortableSlots() {
        document.querySelectorAll('.slot-inner').forEach(slot => {
            new Sortable(slot, {
                group: 'shared',
                animation: 150,
                onAdd: async function (evt) {
                    const item = evt.item;          // ë“œë¡­ëœ ì•„ì´í…œ
                    const masterId = item.dataset.id; // ì—„ë§ˆì˜ í• ì¼ ID
                    
                    // ë“œë¡­ëœ ìœ„ì¹˜ ì •ë³´ íŒŒì•…
                    const parentTd = evt.to.parentElement; 
                    const child = parentTd.dataset.child;
                    const time = parentTd.dataset.time;
                    const date = parentTd.dataset.date; // ì•„ê¹Œ ë„£ì–´ë‘” ë‚ ì§œ ì†ì„±

                    // ì„œë²„ ì €ì¥
                    console.log(`ì €ì¥ ì‹œë„: ${child}, ${date}, ${time}`);
                    const saved = await savePlan(masterId, child, date, time);
                    
                    // ì €ì¥ëœ ID ë¶€ì—¬ (ë‚˜ì¤‘ì— ì‚­ì œí•  ë•Œ í•„ìš”)
                    if(saved) item.dataset.planId = saved.id;
                },
                // ì•„ì´í…œì„ ë°–ìœ¼ë¡œ ë¹¼ë©´ ì‚­ì œ (ì„ íƒ ì‚¬í•­)
                onRemove: function (evt) {
                    // ë‹¤ë¥¸ ìŠ¬ë¡¯ìœ¼ë¡œ ì´ë™í•œê²Œ ì•„ë‹ˆë¼ ì•„ì˜ˆ ëª©ë¡ ë°–ìœ¼ë¡œ ë²„ë ¸ì„ ë•Œ ì²˜ë¦¬ ë¡œì§ í•„ìš” ì‹œ ì¶”ê°€
                }
            });
        });
    }

    // =========================================
    // 3. ì„œë²„ í†µì‹  (ë°ì´í„° ë¡œë“œ & ì €ì¥)
    // =========================================

    // ì—„ë§ˆì˜ í•  ì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    async function loadMasters() {
        try {
            const res = await fetch(`${API_BASE}/masters`);
            const masters = await res.json();
            const container = document.getElementById('masterTodos');
            
            container.innerHTML = masters.map(m => `
                <div class="todo-item" style="background: ${m.color};" data-id="${m.id}">
                    ${m.title}
                    <span class="btn-del-master" onclick="deleteMaster(event, ${m.id})">âŒ</span>
                </div>`
            ).join('');

            // ì—„ë§ˆ ì°½ê³  Sortable (ë³µì œ ëª¨ë“œ)
            new Sortable(container, {
                group: { name: 'shared', pull: 'clone', put: false },
                sort: false, animation: 150
            });
        } catch(err) { console.error(err); }
    }

    // ë°°ì¹˜ëœ ì¼ì • ë¶ˆëŸ¬ì™€ì„œ í™”ë©´ì— ë¿Œë¦¬ê¸°
    async function loadPlans(startDate, endDate) {
        try {
            const res = await fetch(`${API_BASE}/plans?startDate=${startDate}&endDate=${endDate}`);
            const plans = await res.json();

            plans.forEach(p => {
                // ì •í™•í•œ ìœ„ì¹˜(ë‚ ì§œ + ì•„ì´ + ì‹œê°„) ì°¾ê¸°
                const selector = `.child-slot[data-date="${p.planDate}"][data-child="${p.childName}"][data-time="${p.timeSlot}"] .slot-inner`;
                const slot = document.querySelector(selector);
                
                if(slot) {
                    const div = document.createElement('div');
                    div.className = 'todo-item';
                    div.style.background = p.todoMaster.color;
                    // ì™„ë£Œ(ë³„) í‘œì‹œ ì²˜ë¦¬
                    div.innerText = (p.isCompleted ? "â˜… " : "") + p.todoMaster.title;
                    div.dataset.planId = p.id;

                    // [ì¶”ê°€] ì—„ë§ˆ ëª¨ë“œì¼ ë•Œ í´ë¦­ ì‹œ ë³„ í† ê¸€
                    div.onclick = function() {
                        if (isMomMode) toggleComplete(p.id, !p.isCompleted);
                    };
                    
                    // ì‚­ì œ ê¸°ëŠ¥ (ë”ë¸” í´ë¦­ ì‹œ ì‚­ì œ)
                    div.ondblclick = function() { deletePlan(p.id, div); };

                    // [ì¶”ê°€] ëª¨ë°”ì¼: ê¸¸ê²Œ ëˆŒëŸ¬ì„œ ì‚­ì œ (Long Press)
                    let pressTimer;
                    div.addEventListener('touchstart', function() {
                        pressTimer = setTimeout(() => {
                            deletePlan(p.id, div);
                        }, 800); 
                    }, {passive: true});
                    div.addEventListener('touchend', () => clearTimeout(pressTimer));
                    div.addEventListener('touchmove', () => clearTimeout(pressTimer));
                    
                    slot.appendChild(div);
                }
            });
        } catch(err) { console.error("ì¼ì • ë¡œë“œ ì‹¤íŒ¨:", err); }
    }

    // ì¼ì • ì €ì¥ API
    async function savePlan(masterId, child, date, time) {
        try {
            const res = await fetch(`${API_BASE}/plans`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ todoMasterId: masterId, childName: child, planDate: date, timeSlot: time })
            });
            const data = await res.json();
            return data;
        } catch(err) {
            alert("ì €ì¥ ì‹¤íŒ¨!");
            return null;
        }
    }

    // [ì¶”ê°€ ê¸°ëŠ¥] ì¼ì • ì‚­ì œ API (ë”ë¸” í´ë¦­ ì‹œ)
    async function deletePlan(planId, element) {
        if(confirm('ì´ í•  ì¼ì„ ì‚­ì œí• ê¹Œìš”?')) {
            await fetch(`${API_BASE}/plans/${planId}`, { method: 'DELETE' });
            element.remove();
        }
    }

    // [ì¶”ê°€] ë§ˆìŠ¤í„° í•  ì¼ ì‚­ì œ (ë³´ë¬¼ì°½ê³ ì—ì„œ ì œê±°, ê³¼ê±° ê¸°ë¡ì€ ìœ ì§€)
    async function deleteMaster(event, id) {
        event.stopPropagation(); // ë“œë˜ê·¸ ë°©ì§€
        if(!confirm("ë³´ë¬¼ì°½ê³ ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì´ë¯¸ ë°°ì¹˜ëœ ì¼ì •ì€ ìœ ì§€ë©ë‹ˆë‹¤)")) return;

        await fetch(`${API_BASE}/masters/${id}`, { method: 'DELETE' });
        loadMasters(); // ëª©ë¡ ê°±ì‹ 
    }

    // [ì¶”ê°€] ì—„ë§ˆ ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ í† ê¸€
    function toggleMomLogin() {
        if (isMomMode) {
            localStorage.removeItem('mom_access');
            isMomMode = false;
            alert("ì—„ë§ˆ ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            const pw = prompt("ì—„ë§ˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (pw === '0627') {
                localStorage.setItem('mom_access', 'granted');
                isMomMode = true;
                alert("ì—„ë§ˆ ë¡œê·¸ì¸ ì„±ê³µ! í•  ì¼ì„ í´ë¦­í•˜ë©´ ë³„ì„ ì¤„ ìˆ˜ ìˆì–´ìš”.");
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            }
        }
        updateMomBtnUI();
    }

    function checkMomMode() {
        isMomMode = localStorage.getItem('mom_access') === 'granted';
        updateMomBtnUI();
    }

    function updateMomBtnUI() {
        const btn = document.getElementById('momBtn');
        if(isMomMode) {
            btn.innerText = "ğŸ”’ ì—„ë§ˆ ë¡œê·¸ì•„ì›ƒ";
            btn.style.background = "#fab1a0"; 
        } else {
            btn.innerText = "â­ ë³„í‘œì‹œí•˜ê¸°";
            btn.style.background = "#f1c40f"; 
        }
    }

    // [ì¶”ê°€] í•  ì¼ ì™„ë£Œ(ë³„) í† ê¸€ API í˜¸ì¶œ
    async function toggleComplete(planId, newState) {
        await fetch(`${API_BASE}/plans/${planId}/complete`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ isCompleted: newState })
        });
        renderSchedule(); // í™”ë©´ ê°±ì‹ 
    }

    // [ì¶”ê°€] ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
    function downloadScheduleExcel() {
        const wb = XLSX.utils.book_new();
        const data = [];
        
        // í—¤ë” ì¶”ê°€
        data.push(["ë‚ ì§œ", "ì‹œê°„", "í•˜ëŒ", "ì›€ì°¬", "íƒœë‘"]);

        // í˜„ì¬ í™”ë©´ì— í‘œì‹œëœ ë‚ ì§œ(ì»¬ëŸ¼)ë“¤ì„ ìˆœíšŒ
        const columns = document.querySelectorAll('.day-column');
        columns.forEach(col => {
            const isoDate = col.dataset.date; // YYYY-MM-DD

            // í•´ë‹¹ ë‚ ì§œì˜ ì‹œê°„í‘œ í–‰(tr) ìˆœíšŒ
            const rows = col.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const slots = row.querySelectorAll('.child-slot');
                const timeVal = slots[0].dataset.time; // 08:00, 08:30 ë“±
                
                const rowData = [isoDate, timeVal];
                
                // í•˜ëŒ, ì›€ì°¬, íƒœë‘ ìˆœì„œëŒ€ë¡œ í•  ì¼ í…ìŠ¤íŠ¸ ì¶”ì¶œ
                slots.forEach(slot => {
                    const items = Array.from(slot.querySelectorAll('.todo-item'))
                                       .map(item => item.innerText.replace('âŒ', '').trim()) // ì‚­ì œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì œê±°
                                       .join(', ');
                    rowData.push(items);
                });
                data.push(rowData);
            });
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
        ws['!cols'] = [{wch: 12}, {wch: 10}, {wch: 20}, {wch: 20}, {wch: 20}];

        XLSX.utils.book_append_sheet(wb, ws, "ì‹œê°„í‘œ");
        XLSX.writeFile(wb, `ì•„ì´ë“¤_ì‹œê°„í‘œ_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // =========================================
    // 4. íŒì—…ì°½ ê´€ë ¨ (ì—„ë§ˆê°€ í•  ì¼ ì¶”ê°€)
    // =========================================
    async function saveNewMaster() {
        const title = document.getElementById('newTodoTitle').value;
        const color = document.getElementById('selectedColor').value;
        if (!title) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");

        await fetch(`${API_BASE}/masters`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, color })
        });
        
        closeModal();
        loadMasters();
        document.getElementById('newTodoTitle').value = '';
    }

    function openModal() { document.getElementById('todoModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('todoModal').style.display = 'none'; }
    function selectColor(el) {
        document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('selectedColor').value = el.style.backgroundColor; 
    }
</script>
</body>
</html>         // í•˜ëŒ, ì›€ì°¬, íƒœë‘ ìˆœì„œëŒ€ë¡œ í•  ì¼ í…ìŠ¤íŠ¸ ì¶”ì¶œ
                slots.forEach(slot => {
                    const items = Array.from(slot.querySelectorAll('.todo-item'))
                                       .map(item => item.innerText.replace('âŒ', '').trim()) // ì‚­ì œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì œê±°
                                       .join(', ');
                    rowData.push(items);
                });
                data.push(rowData);
            });
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
        ws['!cols'] = [{wch: 12}, {wch: 10}, {wch: 20}, {wch: 20}, {wch: 20}];

        XLSX.utils.book_append_sheet(wb, ws, "ì‹œê°„í‘œ");
        XLSX.writeFile(wb, `ì•„ì´ë“¤_ì‹œê°„í‘œ_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // =========================================
    // 4. íŒì—…ì°½ ê´€ë ¨ (ì—„ë§ˆê°€ í•  ì¼ ì¶”ê°€)
    // =========================================
    async function saveNewMaster() {
        const title = document.getElementById('newTodoTitle').value;
        const color = document.getElementById('selectedColor').value;
        if (!title) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");

        await fetch(`${API_BASE}/masters`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, color })
        });
        
        closeModal();
        loadMasters();
        document.getElementById('newTodoTitle').value = '';
    }

    function openModal() { document.getElementById('todoModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('todoModal').style.display = 'none'; }
    function selectColor(el) {
        document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('selectedColor').value = el.style.backgroundColor; 
    }
</script>
</body>
</html>