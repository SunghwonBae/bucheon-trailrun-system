<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ ê´€ë¦¬ìí˜ì´ì§€</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <!-- Google Maps API: YOUR_API_KEY ë¶€ë¶„ì„ ì‹¤ì œ ë°œê¸‰ë°›ì€ í‚¤ë¡œ ë³€ê²½í•´ì•¼ ì§€ë„ê°€ ë³´ì…ë‹ˆë‹¤. -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAXNCrPrwPfVgDHDLiumDwjYbkpV7UGRDE&callback=initMap"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { cursor: pointer; background: #f8f9fa; border: 1px solid #ddd; padding: 10px; }
        th:hover { background: #e9ecef; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        input[type="text"], input[type="number"] { width: 90%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ í†µì¼ */
        .btn { 
            padding: 10px 15px; border: none; border-radius: 5px; color: white; 
            cursor: pointer; font-size: 0.9rem; font-weight: bold; 
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-excel { background: #27ae60; }
        .btn-add { background: #16a085; }
        .btn-template { background: #34495e; }
        .btn-upload { background: #9b59b6; }
        .btn-reset { background: #e74c3c; }
        .btn-home { background: #2980b9; }
        .btn-cert { background: #f39c12; }
        #map { width: 100%; height: 400px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px; }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 1.1rem; margin-bottom: 15px; }
            
            /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ ì„¸ë¡œ ì •ë ¬ */
            .controls { flex-direction: column; align-items: stretch; gap: 10px; }
            .controls > button, .controls > div { width: 100%; margin: 0; }
            .controls > div { 
                border-left: none !important; padding-left: 0 !important; 
                flex-direction: column; align-items: stretch; 
            }
            .controls input, .controls select, .controls label { width: 100%; box-sizing: border-box; margin: 5px 0; text-align: center; }
            
            /* í…Œì´ë¸” ê°€ë¡œ ìŠ¤í¬ë¡¤ ì²˜ë¦¬ */
            #runnerTable { display: block; overflow-x: auto; white-space: nowrap; }
            th, td { padding: 8px 5px; font-size: 0.9rem; }
            .btn { padding: 12px; font-size: 1rem; }
        }

        /* [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•Œë¦¼/ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .toast-message {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 25px;
            font-size: 1rem; z-index: 4000; opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .toast-message.show { opacity: 1; }

        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 5000;
        }
        .custom-modal-box {
            background: white; padding: 25px; border-radius: 15px; width: 300px;
            text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .custom-modal-text { margin-bottom: 20px; font-size: 1.1rem; word-break: keep-all; }
        .custom-modal-btns { display: flex; gap: 10px; justify-content: center; }
        .custom-modal-btn {
            flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
        }
        .btn-confirm-yes { background: #e74c3c; color: white; }
        .btn-confirm-no { background: #95a5a6; color: white; }
        .btn-alert-ok { background: #3498db; color: white; width: 100%; }

        /* [ì¶”ê°€] ì¹´ìš´íŠ¸ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
        .countdown-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none;
            justify-content: center; align-items: center; z-index: 6000;
        }
        #countdownNumber {
            font-size: 15rem; color: #f1c40f; font-weight: bold;
            font-variant-numeric: tabular-nums;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <h1 id="raceTitle">ğŸƒë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ ê´€ë¦¬ì</h1>

    <div class="controls">
        <button class="btn btn-home" onclick="location.href='/'">ğŸ  ì „ê´‘íŒìœ¼ë¡œ</button>
        <button class="btn btn-add" onclick="addNewRow()">â• ì„ ìˆ˜ì¶”ê°€</button>
        <button class="btn btn-excel" onclick="downloadExcel()">ğŸ“Š ì „ì²´ëª©ë¡ ì•¡ì…€ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn btn-template" onclick="downloadTemplate()">ğŸ“¥ ì—…ë¡œë“œí…œí”Œë¦¿ë‹¤ìš´</button>
    
        <div style="border-left: 2px solid #ccc; padding-left: 15px; display: flex; align-items: center; gap: 10px;">
            <label for="excelFile" class="btn btn-upload">ì—…ë¡œë“œíŒŒì¼ ì„ íƒ</label>
            <input type="file" id="excelFile" accept=".xlsx, .xls" style="display: none;" onchange="uploadExcel(this)">
            <span id="fileName" style="font-size: 0.85rem; color: #666;">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
        </div>
        <button class="btn btn-reset" onclick="resetAllRecords()">ğŸ”„ ëª¨ë“  ê¸°ë¡ ì´ˆê¸°í™”</button>
        <button class="btn btn-cert" onclick="location.href='/certificate.html'">ğŸ† ìƒì¥ ì¶œë ¥ í™”ë©´</button>

        <div style="border-left: 2px solid #ccc; padding-left: 10px; display: flex; align-items: center; gap: 5px;">
            <select id="rankLimitSelect" onchange="updateSettings()" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                <option value="3" selected>3ìœ„ê¹Œì§€</option>
                <option value="4">4ìœ„ê¹Œì§€</option>
                <option value="5">5ìœ„ê¹Œì§€</option>
            </select>
            <input type="number" id="seniorYearInput" onchange="updateSettings()" style="width: 60px; padding: 8px; text-align: center;" placeholder="ë…„ë„">
            <span style="font-size: 0.8rem; color: #666;">ë…„ìƒê¹Œì§€ ì¥ë…„</span>

            <span style="margin-left: 10px; border-left: 1px solid #ccc; padding-left: 10px;">ğŸ“¡ ë°˜ê²½:</span>
            <select id="radiusSelect" onchange="updateRadius()" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                <option value="10">10m</option>
                <option value="20" selected>20m</option>
                <option value="30">30m</option>
                <option value="40">40m</option>
                <option value="50">50m</option>
            </select>
        </div>
    </div>

    <!-- ì§€ë„ ì˜ì—­ -->
    <div id="map"></div>

    <table id="runnerTable">
        <thead>
            <tr>
                <th onclick="sortTable(0)" style="width: 70px;">ë°°ë²ˆ <span id="sort-icon-0">â†•</span></th>
                <th onclick="sortTable(1)">ì´ë¦„ <span id="sort-icon-1">â†•</span></th>
                <th onclick="sortTable(2)" style="width: 50px;">ì„±ë³„ <span id="sort-icon-2">â†•</span></th>
                <th onclick="sortTable(3)" style="width: 80px;">ë…„ìƒ <span id="sort-icon-3">â†•</span></th>
                <th onclick="sortTable(4)">ì†Œì† <span id="sort-icon-4">â†•</span></th>
                <th onclick="sortTable(5)">ì—°ë½ <span id="sort-icon-5">â†•</span></th>
                <th onclick="sortTable(6)">ì…ê¸ˆ <span id="sort-icon-6">â†•</span></th>
                <th onclick="sortTable(7)">ê¸°ë¡ <span id="sort-icon-7">â†•</span></th>
                <th onclick="sortTable(8)">ê¸°ë¡ì¦ <span id="sort-icon-8">â†•</span></th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody id="runnerList"></tbody>
    </table>

    <!-- ì»¤ìŠ¤í…€ ì•Œë¦¼/ëª¨ë‹¬ ìš”ì†Œ -->
    <div id="toastMessage" class="toast-message">ì•Œë¦¼</div>

    <div id="confirmModal" class="custom-modal-overlay">
        <div class="custom-modal-box">
            <div id="confirmText" class="custom-modal-text">í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
            <div class="custom-modal-btns">
                <button class="custom-modal-btn btn-confirm-no" onclick="closeConfirm(false)">ì·¨ì†Œ</button>
                <button class="custom-modal-btn btn-confirm-yes" onclick="closeConfirm(true)">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="alertModal" class="custom-modal-overlay">
        <div class="custom-modal-box">
            <div id="alertText" class="custom-modal-text">ì•Œë¦¼</div>
            <div class="custom-modal-btns">
                <button class="custom-modal-btn btn-alert-ok" onclick="closeAlert()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="countdownOverlay" class="countdown-overlay">
        <div id="countdownNumber">5</div>
    </div>

    <script>
        const socket = io();
        const currentYear = new Date().getFullYear();
        document.title = `${currentYear} ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ-ê´€ë¦¬ì`;
        document.getElementById('raceTitle').innerText = `ğŸƒ${currentYear} ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ-ê´€ë¦¬ì`;
        // êµ¬ê¸€ ì§€ë„ ê´€ë ¨ ë³€ìˆ˜ ë° í•¨ìˆ˜
        let map, marker;
        let savedFinishLine = { lat: 37.503, lng: 126.795 }; // ê¸°ë³¸ê°’

        // [ì¶”ê°€] ì»¤ìŠ¤í…€ UI í—¬í¼ í•¨ìˆ˜ë“¤
        function showToast(msg) {
            const el = document.getElementById('toastMessage');
            el.innerText = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 2000);
        }

        let confirmCallback = null;
        function showConfirm(msg, onYes, onNo) {
            document.getElementById('confirmText').innerText = msg;
            document.getElementById('confirmModal').style.display = 'flex';
            confirmCallback = (result) => {
                if(result && onYes) onYes();
                else if(!result && onNo) onNo();
            };
        }
        function closeConfirm(result) {
            document.getElementById('confirmModal').style.display = 'none';
            if(confirmCallback) confirmCallback(result);
            confirmCallback = null;
        }

        let alertCallback = null;
        function showAlert(msg, onOk) {
            document.getElementById('alertText').innerText = msg;
            document.getElementById('alertModal').style.display = 'flex';
            alertCallback = onOk;
        }
        function closeAlert() {
            document.getElementById('alertModal').style.display = 'none';
            if(alertCallback) alertCallback();
            alertCallback = null;
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 17,
                center: savedFinishLine,
            });

            marker = new google.maps.Marker({
                position: savedFinishLine,
                map: map,
                title: "ê³¨ì¸ ì§€ì ",
                draggable: true // ë§ˆì»¤ ë“œë˜ê·¸ ê°€ëŠ¥
            });

            // ì§€ë„ í´ë¦­ ì‹œ
            map.addListener("click", (e) => {
                updateMarkerPosition(e.latLng.lat(), e.latLng.lng());
            });

            // ë§ˆì»¤ ë“œë˜ê·¸ ì¢…ë£Œ ì‹œ
            marker.addListener("dragend", (e) => {
                updateMarkerPosition(e.latLng.lat(), e.latLng.lng());
            });
        }

        function updateMarkerPosition(lat, lng) {
            showConfirm("ì´ ìœ„ì¹˜ë¥¼ ê³¨ì¸ ì§€ì ìœ¼ë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => {
                socket.emit('update_finish_line', { lat, lng });
            }, () => {
                marker.setPosition(savedFinishLine); // ì·¨ì†Œ ì‹œ ì›ë˜ ìœ„ì¹˜ë¡œ ë³µê·€
            });
        }

        // ì´ˆê¸° ì„¤ì •ê°’ ìˆ˜ì‹  ë° ë™ê¸°í™”
        socket.on('current_settings', (data) => {
            if(data.rankLimit) document.getElementById('rankLimitSelect').value = data.rankLimit;
            if(data.seniorYear) document.getElementById('seniorYearInput').value = data.seniorYear;
            if(data.goalRadius) document.getElementById('radiusSelect').value = data.goalRadius;
            if(data.finishLine) updateMapLocation(data.finishLine);
        });

        socket.on('settings_changed', (data) => {
            if(data.rankLimit) document.getElementById('rankLimitSelect').value = data.rankLimit;
            if(data.seniorYear) document.getElementById('seniorYearInput').value = data.seniorYear;
        });

        socket.on('radius_changed', (val) => {
            document.getElementById('radiusSelect').value = val;
        });

        socket.on('finish_line_changed', (pos) => {
            updateMapLocation(pos);
            showToast("ê³¨ì¸ ì§€ì ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        });

        // [ì¶”ê°€] ì„œë²„ë¡œë¶€í„° ì¹´ìš´íŠ¸ë‹¤ìš´ ìˆ˜ì‹ 
        socket.on('countdown', (count) => {
            const overlay = document.getElementById('countdownOverlay');
            const num = document.getElementById('countdownNumber');
            
            if (count > 0) {
                overlay.style.display = 'flex';
                num.innerText = count;
            } else {
                overlay.style.display = 'none';
            }
        });

        socket.on('race_status', (data) => {
            if (data.isStarted) {
                document.getElementById('countdownOverlay').style.display = 'none';
            }
        });

        // [ì¶”ê°€] UI ì—…ë°ì´íŠ¸ ìˆ˜ì‹  ì‹œ ëª©ë¡ ê°±ì‹  ë° ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬
        socket.on('update_ui', () => fetchRunners());
        socket.on('error_msg', (msg) => showToast(msg));

        function updateMapLocation(pos) {
            savedFinishLine = pos;
            if (map && marker) {
                map.setCenter(pos);
                marker.setPosition(pos);
            }
        }

        function updateSettings() {
            const rankLimit = document.getElementById('rankLimitSelect').value;
            const seniorYear = document.getElementById('seniorYearInput').value;
            socket.emit('update_race_settings', { rankLimit, seniorYear });
            showToast("ëŒ€íšŒ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function updateRadius() {
            const val = document.getElementById('radiusSelect').value;
            socket.emit('update_radius', val);
            showToast("ë°˜ê²½ ì„¤ì •ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // 1. ì§ì ‘ ì ‘ì† ì°¨ë‹¨ ë¡œì§ (í˜ì´ì§€ ìµœìƒë‹¨)
        if (localStorage.getItem('admin_access') !== 'granted') {
            showAlert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ì—ì„œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", () => {
                location.href = '/';
            });
        }

        // ì‹œê°„ í¬ë§· í•¨ìˆ˜ (HH:mm:ss)
        function formatTime(dateStr, startTimeStr) {
            if (!dateStr || !startTimeStr) return "-";
            const diff = new Date(dateStr) - new Date(startTimeStr);
            if (diff < 0) return "-";
            return new Date(diff).toISOString().substr(11, 8);
        }

        let runnersData = [];

        // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function fetchRunners() {
            const res = await fetch('/api/runners');
            runnersData = await res.json();
            renderTable(runnersData);
        }

        function renderTable(data) {
            const tbody = document.getElementById('runnerList');
            
            // [ìˆ˜ì •] ì…ë ¥ ì¤‘ì¸ ì‹ ê·œ í–‰(new-runner-row)ì€ ìœ ì§€í•˜ê¸° ìœ„í•´ ì ì‹œ ëŒ€í”¼
            const newRows = tbody.querySelectorAll('.new-runner-row');
            const fragment = document.createDocumentFragment();
            newRows.forEach(row => fragment.appendChild(row));

            tbody.innerHTML = '';
            tbody.appendChild(fragment); // ëŒ€í”¼ì‹œì¼°ë˜ ì‹ ê·œ í–‰ ë³µêµ¬

            data.forEach(r => {
                const recordStr = formatTime(r.finishTime, r.startTime);
                const row = `<tr id="row-${r.id}">
                    <td><input type="text" value="${r.bibNumber}" onchange="updateField(${r.id}, 'bibNumber', this.value)"></td>
                    <td><input type="text" value="${r.name || ''}" onchange="updateField(${r.id}, 'name', this.value)"></td>
                    <td><input type="text" value="${r.gender || ''}" onchange="updateField(${r.id}, 'gender', this.value)"></td>
                    <td><input type="number" value="${r.birthYear || ''}" onchange="updateField(${r.id}, 'birthYear', this.value)"></td>
                    <td><input type="text" value="${r.affiliation || ''}" onchange="updateField(${r.id}, 'affiliation', this.value)"></td>
                    <td><input type="text" value="${r.phone || ''}" onchange="updateField(${r.id}, 'phone', this.value)"></td>

                    <td>
                        <select onchange="updateField(${r.id}, 'paymentStatus', this.value)" 
                                style="background: ${r.paymentStatus==='Y'?'#d4edda':r.paymentStatus==='F'?'#e2e3e5':'#f8d7da'}">
                            <option value="Y" ${r.paymentStatus==='Y'?'selected':''}>Y (í™•ì¸)</option>
                            <option value="N" ${r.paymentStatus==='N'?'selected':''}>N (ë¯¸ì…ê¸ˆ)</option>
                            <option value="F" ${r.paymentStatus==='F'?'selected':''}>F (ë¬´ë£Œ)</option>
                        </select>
                    </td>
                    <td>
                        ${recordStr}
                        ${r.finishTime ? `<button onclick="cancelFinish('${r.bibNumber}')" style="margin-left:5px; color:red; border:none; background:none; cursor:pointer; font-weight:bold;" title="ê¸°ë¡ ì·¨ì†Œ">X</button>` : ''}
                    </td> 
                    <td>
                        <span id="print-count-${r.id}">${r.printCount}</span>íšŒ
                        ${r.finishTime ? 
                            `<button onclick="printCertificate(${r.id}, '${r.bibNumber}')">ğŸ–¨ï¸ì¶œë ¥</button>` : 
                            `<span style="color:#ccc; font-size:0.8rem;">ê³¨ì¸ì „</span>`
                        }
                    </td>
                    <td><button onclick="deleteRunner(${r.id})" style="color:red; border:none; background:none; cursor:pointer;">âŒ</button></td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        // ì¸ë¼ì¸ ìˆ˜ì • í•¨ìˆ˜
        async function updateField(id, field, value) {
            const body = {};
            body[field] = field === 'birthYear' ? Number(value) : value;
            
            await fetch(`/api/runners/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            showToast("ì„ ìˆ˜ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // ê¸°ë¡ì¦ ì¸ì‡„ ë° ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        async function printCertificate(id, bib) {
            // 1. ì¹´ìš´íŠ¸ ì¦ê°€ ìš”ì²­
            const res = await fetch(`/api/runners/${id}/print`, { method: 'POST' });
            const result = await res.json();
            
            // 2. í™”ë©´ì˜ ì¹´ìš´íŠ¸ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            document.getElementById(`print-count-${id}`).innerText = result.printCount;

            // 3. ê¸°ë¡ì¦ ì¸ì‡„ íŒì—… ì°½ ì—´ê¸°
            // ì„¤ì • íŒ¨ë„ê³¼ A4 ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìœ„í•´ ì ì ˆí•œ í¬ê¸°ë¡œ íŒì—…ì„ ì—½ë‹ˆë‹¤.
            const width = 1000;
            const height = 900;
            const left = (window.screen.width - width) / 2;
            const top = (window.screen.height - height) / 2;
            
            window.open(`/certificate_single.html?bib=${bib}`, 'CertificateWindow', 
                `width=${width},height=${height},top=${top},left=${left},scrollbars=yes,resizable=yes`);
        }

        // [ì¶”ê°€] ì™„ì£¼ ê¸°ë¡ ì·¨ì†Œ ìš”ì²­
        function cancelFinish(bib) {
            showConfirm(`${bib}ë²ˆ ì„ ìˆ˜ì˜ ì™„ì£¼ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => {
                socket.emit('cancel_runner_finish', bib);
            });
        }

        // ê¸°ë¡ ì´ˆê¸°í™” (3ê°€ì§€ ì¹¼ëŸ¼ í†µí•© ì‚­ì œ)
        async function resetAllRecords() {
            showConfirm("ëª¨ë“  ì„ ìˆ˜ì˜ ì¶œë°œ, ë„ì°©(ìˆ˜ë™/ìë™) ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", async () => {
                await fetch('/api/runners/reset-records', { method: 'POST' });
                showAlert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                fetchRunners();
            });
        }

        // 1. ì—…ë¡œë“œìš© í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadTemplate() {
            const templateData = [
                { bibNumber: "101", name: "í™ê¸¸ë™", gender: "ë‚¨", birthYear: 1980, affiliation: "ë¶€ì²œíŠ¸ë¼ì´", phone: "010-1234-5678", paymentStatus: "N" }
            ];
            const worksheet = XLSX.utils.json_to_sheet(templateData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
            XLSX.writeFile(workbook, "runner_template.xlsx");
        }

        // 2. ì—‘ì…€ íŒŒì¼ ì½ê¸° ë° ì„œë²„ ì „ì†¡
        function uploadExcel(input) {
            const file = input.files[0];
            if (!file) return;
            
            document.getElementById('fileName').innerText = file.name;
            const reader = new FileReader();

            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                showConfirm(`${json.length}ëª…ì˜ ë°ì´í„°ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë°°ë²ˆ ì¤‘ë³µ ì‹œ ê¸°ì¡´ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.)`, async () => {
                    try {
                        const response = await fetch('/api/runners/bulk', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(json)
                        });
                        const result = await response.json();
                        showAlert(result.message);
                        fetchRunners(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    } catch (err) {
                        showAlert("ì—…ë¡œë“œ ì‹¤íŒ¨: ë°ì´í„° í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    }
                });
                input.value = ''; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            };
            reader.readAsArrayBuffer(file);
        }

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        function downloadExcel() {
            const exportData = runnersData.map(r => ({
                "ë°°ë²ˆ": r.bibNumber,
                "ì´ë¦„": r.name,
                "ì„±ë³„": r.gender,
                "ì¶œìƒë…„ë„": r.birthYear,
                "ê¸°ë¡": formatTime(r.finishTime, r.startTime), // ì—‘ì…€ì—ë„ ì‹œ:ë¶„:ì´ˆ í¬í•¨
                "ì—°ë½ì²˜": r.phone,
                "ì†Œì†": r.affiliation,
                "ì…ê¸ˆ": r.paymentStatus
            }));
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "ì„ ìˆ˜ëª…ë‹¨");
            XLSX.writeFile(workbook, "trail_runners_final.xlsx");
        }

        // í…Œì´ë¸” ì •ë ¬
        let currentSortCol = -1;
        let currentSortAsc = true;

        function sortTable(n) {
            // ì •ë ¬ ë°©í–¥ ë° ì»¬ëŸ¼ ì„¤ì •
            if (currentSortCol === n) {
                currentSortAsc = !currentSortAsc;
            } else {
                currentSortCol = n;
                currentSortAsc = true;
            }

            // í—¤ë” ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            for (let i = 0; i <= 8; i++) {
                const iconSpan = document.getElementById(`sort-icon-${i}`);
                if (iconSpan) {
                    iconSpan.innerText = (i === n) ? (currentSortAsc ? 'â–²' : 'â–¼') : 'â†•';
                    iconSpan.style.color = (i === n) ? '#e74c3c' : '#ccc';
                }
            }

            const sorted = [...runnersData].sort((a, b) => {
                const fields = ['bibNumber', 'name', 'gender', 'birthYear', 'affiliation', 'phone', 'paymentStatus', 'finishTime', 'printCount'];
                let valA = a[fields[n]];
                let valB = b[fields[n]];
                
                if (valA == null) valA = '';
                if (valB == null) valB = '';
                
                // ìˆ«ì ë¹„êµ (ë°°ë²ˆ, ì¶œìƒë…„ë„, ì¸ì‡„ìˆ˜)
                if (n === 0 || n === 3 || n === 8) {
                    valA = Number(valA);
                    valB = Number(valB);
                }

                if (valA < valB) return currentSortAsc ? -1 : 1;
                if (valA > valB) return currentSortAsc ? 1 : -1;
                return 0;
            });
            renderTable(sorted);
        }

        // [ê¸°ëŠ¥] ì‹ ê·œ ì„ ìˆ˜ í–‰ ì¶”ê°€
        function addNewRow() {
            const tbody = document.getElementById('runnerList');
            const tr = document.createElement('tr');
            tr.className = 'new-runner-row'; // [ìˆ˜ì •] ì‹ ê·œ í–‰ ì‹ë³„ í´ë˜ìŠ¤ ì¶”ê°€
            tr.style.background = "#e8f8f5"; // ì‹ ê·œ í–‰ ê°•ì¡° ìƒ‰ìƒ
            tr.innerHTML = `
                <td><input type="text" placeholder="ë°°ë²ˆ" class="new-bib"></td>
                <td><input type="text" placeholder="ì´ë¦„" class="new-name"></td>
                <td><input type="text" placeholder="ì„±ë³„" class="new-gender"></td>
                <td><input type="number" placeholder="ë…„ë„" class="new-birth"></td>
                <td><input type="text" placeholder="ì†Œì†" class="new-affil"></td>
                <td><input type="text" placeholder="ì—°ë½ì²˜" class="new-phone"></td>
                <td>
                    <select class="new-payment">
                        <option value="N">N (ë¯¸ì…ê¸ˆ)</option>
                        <option value="Y">Y (í™•ì¸)</option>
                        <option value="F">F (ë¬´ë£Œ)</option>
                    </select>
                </td>
                <td>-</td>
                <td>-</td>
                <td>
                    <button onclick="saveNewRunner(this)" class="btn" style="background:#2ecc71; padding:5px 10px; font-size:0.8rem;">ğŸ’¾ ì €ì¥</button>
                    <button onclick="this.closest('tr').remove()" class="btn" style="background:#95a5a6; padding:5px 10px; font-size:0.8rem;">âŒ ì·¨ì†Œ</button>
                </td>
            `;
            tbody.prepend(tr); // ìµœìƒë‹¨ì— ì¶”ê°€
        }

        // [ê¸°ëŠ¥] ì‹ ê·œ ì„ ìˆ˜ ì €ì¥
        async function saveNewRunner(btn) {
            const tr = btn.closest('tr');
            const bib = tr.querySelector('.new-bib').value;
            const name = tr.querySelector('.new-name').value;

            if(!bib || !name) return showToast("ë°°ë²ˆê³¼ ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

            const newRunner = {
                bibNumber: bib,
                name: name,
                gender: tr.querySelector('.new-gender').value,
                birthYear: tr.querySelector('.new-birth').value,
                affiliation: tr.querySelector('.new-affil').value,
                phone: tr.querySelector('.new-phone').value,
                paymentStatus: tr.querySelector('.new-payment').value
            };

            try {
                // ê¸°ì¡´ Bulk API ì¬ì‚¬ìš© (ë°°ì—´ë¡œ ì „ì†¡)
                const response = await fetch('/api/runners/bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify([newRunner])
                });
                const result = await response.json();
                showToast("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                tr.remove(); // ì…ë ¥ í–‰ ì‚­ì œ
                fetchRunners(); // ëª©ë¡ ê°±ì‹ 
            } catch (err) {
                console.error(err);
                showAlert("ì €ì¥ ì‹¤íŒ¨: ë°°ë²ˆ ì¤‘ë³µ ë“±ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
        }

        // [ì¶”ê°€] ì„ ìˆ˜ ì‚­ì œ í•¨ìˆ˜
        function deleteRunner(id) {
            showConfirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", async () => {
                try {
                    await fetch(`/api/runners/${id}`, { method: 'DELETE' });
                    showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    
                    // [ë³€ê²½] ì „ì²´ ë¦¬ë¡œë“œ ëŒ€ì‹  í•´ë‹¹ í–‰ë§Œ ì‚­ì œ
                    const row = document.getElementById(`row-${id}`);
                    if (row) row.remove();
                    
                    // ë°ì´í„° ë°°ì—´ì—ì„œë„ ì œê±° (ì •ë ¬ ì‹œ ì¬ë“±ì¥ ë°©ì§€)
                    runnersData = runnersData.filter(r => r.id !== id);
                } catch (err) {
                    console.error(err);
                    showAlert("ì‚­ì œ ì‹¤íŒ¨");
                }
            });
        }

        fetchRunners();
    </script>
</body>
</html>