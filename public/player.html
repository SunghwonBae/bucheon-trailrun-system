<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ - ìë™ê³¨ì¸</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; text-align: center; margin: 0; padding: 0; background: #f4f7f6; color: #333; }
        
        /* ìµœìƒë‹¨ ê³µì§€ì‚¬í•­ ìŠ¤íƒ€ì¼ */
        .notice-banner { 
            background: #fff3cd; 
            color: #856404; 
            padding: 15px; 
            border-bottom: 2px solid #ffeeba;
            font-size: 0.95rem;
            line-height: 1.5;
            font-weight: bold;
            text-align: left;
        }
        .notice-banner span { color: #d63031; display: block; margin-bottom: 5px; font-size: 1.1rem; }

        .content { padding: 30px 20px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        input { font-size: 1.8rem; width: 80%; padding: 12px; margin: 20px 0; border: 2px solid #ddd; border-radius: 10px; text-align: center; }
        input:focus { border-color: #e67e22; outline: none; }

        .btn-start { 
            background: #e67e22; color: white; padding: 18px 40px; border: none; 
            border-radius: 50px; font-size: 1.3rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.3s;
        }
        .btn-start:disabled { background: #95a5a6; }

        #status { margin-top: 25px; font-size: 1.1rem; color: #7f8c8d; }
        .tracking-on { color: #27ae60; font-weight: bold; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <h1 id="raceTitle">ğŸƒ ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ ìë™ê³¨ì¸</h1>
    <div class="notice-banner">
        <span>âš ï¸ ìë™ ê³¨ì¸ ì‹œìŠ¤í…œ ì•ˆë‚´</span>
        1. <strong>ê³µì‹ ê¸°ë¡ ìš°ì„ :</strong> GPX ê¸°ë¡ì€ ë³´ì™„ìš©ì´ë©°, ìµœì¢… ìˆœìœ„ëŠ” <strong>ì‹¬íŒì˜ ìˆ˜ë™ ê¸°ë¡ì´ ìš°ì„ </strong>í•©ë‹ˆë‹¤.<br>
        2. <strong>í™œì„±í™” ì¡°ê±´:</strong> ì¶œë°œ ë²„íŠ¼ ì…ë ¥ í›„ <strong>30ë¶„ì´ ê²½ê³¼í•´ì•¼</strong> ìë™ ê³¨ì¸ì´ ì‘ë™í•©ë‹ˆë‹¤.<br>
        3. <strong>ì¸ì‹ ë²”ìœ„:</strong> ê³¨ì¸ ì§€ì  <strong>ë°˜ê²½ 20m ì´ë‚´</strong> ì§„ì… ì‹œ ìë™ ê°ì§€ë©ë‹ˆë‹¤.<br>
        4. <strong>ì£¼ì˜ ì‚¬í•­:</strong> ì •í™•í•œ ì¸¡ì •ì„ ìœ„í•´ ìŠ¤ë§ˆíŠ¸í°ì˜ <strong>í™”ë©´ì„ ë„ì§€ ë§ê³ </strong> íœ´ëŒ€í•´ ì£¼ì„¸ìš”.
    </div>

    <div class="content">
        <div class="card">
        <h2>ğŸ ìë™ ì²´í¬ì¸ ëŒ€ê¸°</h2>
            <div id="statusMessage" style="margin-bottom: 15px; font-size: 0.9rem; color: #2980b9; background: #ebf5fb; padding: 10px; border-radius: 8px;">
                ë°°ë²ˆ ì…ë ¥ í›„ ì¶”ì ì„ ì‹œì‘í•˜ë©´,<br><strong>ì¶œë°œ 30ë¶„ í›„ë¶€í„°</strong> 20m ë°˜ê²½ ì§„ì… ì‹œ ê³¨ì¸ ì²˜ë¦¬ë©ë‹ˆë‹¤.
            </div>

            <input type="number" id="bibNumber" placeholder="ë°°ë²ˆ ì…ë ¥" inputmode="numeric">
            
            <div style="margin: 20px 0; font-size: 0.85rem; color: #e74c3c;">
                * ìœ„ì¹˜ ì¶”ì  ë™ì˜ ì‹œ ìœ„ ì•ˆë‚´ ì‚¬í•­ì— ë™ì˜í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
            </div>

            <button class="btn-start" id="startBtn" onclick="startTracking()">ìœ„ì¹˜ ì¶”ì  ë° ë™ì˜ ì‹œì‘</button>
            
            <div id="status">ì—°ê²° ëŒ€ê¸° ì¤‘...</div>
        </div>
    </div>
  
    <div id="distanceDisplay" style="display:none; margin: 20px 0; padding: 20px; background: #2c3e50; color: #f1c40f; border-radius: 15px;">
        <div style="font-size: 1rem; color: #fff;">ê³¨ì¸ ì§€ì ê¹Œì§€ ë‚¨ì€ ê±°ë¦¬</div>
        <div style="font-size: 3.5rem; font-weight: bold;"><span id="distNum">--</span>m</div>
        <div id="radiusGuide" style="font-size: 0.9rem; color: #bdc3c7; margin-top:5px;">(20m ì´ë‚´ ì§„ì… ì‹œ ìë™ ê³¨ì¸)</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let watchId = null;

                // [ìë™ ì„¤ì •] í˜„ì¬ ì—°ë„ ì ìš©
        const currentYear = new Date().getFullYear();
        document.title = `${currentYear} ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ - ìë™ê³¨ì¸`;
        document.getElementById('raceTitle').innerText = `ğŸƒ ${currentYear} ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ - ìë™ê³¨ì¸`;

        function startTracking() {
            const bib = document.getElementById('bibNumber').value;
            if(!bib) return alert("ë°°ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”!");

            if (navigator.geolocation) {
                // ì •í™•ë„ ë†’ì€ ìœ„ì¹˜ ì¶”ì  ì˜µì…˜
                const options = {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 10000
                };

                watchId = navigator.geolocation.watchPosition((pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    
                    document.getElementById('status').innerHTML = 
                        `<div class="tracking-on">ğŸ“ ìœ„ì¹˜ ì¶”ì  ê°€ë™ ì¤‘</div>
                         <div style="font-size: 0.8rem; margin-top: 5px;">í™”ë©´ì„ ë„ì§€ ë§ê³  íœ´ëŒ€í•´ ì£¼ì„¸ìš”.</div>`;
                    
                    socket.emit('player_location', { 
                        bibNumber: bib, 
                        lat: lat, 
                        lng: lng 
                    });
                }, (err) => {
                    alert("GPS ìˆ˜ì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.");
                }, options);
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('startBtn').innerText = "ì¶”ì  ì¤‘ (ê³µì‹ ê¸°ë¡ ëŒ€ê¸°)";
            } else {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì¶”ì ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        }

        socket.on('auto_goal_success', (data) => {
            alert(`[ê°ì§€ ì„±ê³µ] ${data.name}ë‹˜, ê³¨ì¸ ì§€ì  í†µê³¼ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ìµœì¢… ìˆœìœ„ëŠ” ì‹¬íŒ íŒì • í›„ í™•ì •ë©ë‹ˆë‹¤.`);
            location.href = "/"; 
        });

        socket.on('distance_update', (data) => {
            const distBox = document.getElementById('distanceDisplay');
            const distNum = document.getElementById('distNum');
            distBox.style.display = 'block';
            distNum.innerText = data.distance;

            // ê±°ë¦¬ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€í™” (ê°€ê¹Œì›Œì§€ë©´ ì´ˆë¡ìƒ‰)
            if(data.distance <= 20) {
                distNum.style.color = "#2ecc71";
            } else {
                distNum.style.color = "#f1c40f";
            }
        });

        socket.on('radius_changed', (val) => {
            document.getElementById('radiusGuide').innerText = `(${val}m ì´ë‚´ ì§„ì… ì‹œ ìë™ ê³¨ì¸)`;
        });
    </script>
</body>
</html>