<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ - ìë™ê³¨ì¸</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e67e22;
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #2d3436;
            --shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        body { 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background: var(--bg); color: var(--text);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }
        
        .main-container { width: 100%; max-width: 480px; }

        h1 { 
            font-size: 1.6rem; color: var(--primary); margin: 20px 0; 
            text-align: center; font-weight: 800; letter-spacing: -0.5px;
        }

        .notice-banner { 
            background: #fff8e1; border-left: 5px solid #ffc107;
            padding: 15px; border-radius: 12px;
            font-size: 0.9rem; line-height: 1.6; color: #5d4037;
            margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: left;
        }
        .notice-banner strong { color: #d35400; }

        .card { 
            background: var(--card-bg); padding: 30px 25px; 
            border-radius: 20px; box-shadow: var(--shadow);
            text-align: center; margin-bottom: 20px;
        }
        .card h2 { margin-top: 0; font-size: 1.4rem; color: var(--primary); }
        
        input { 
            font-size: 1.5rem; width: 100%; padding: 15px; margin: 20px 0; 
            border: 2px solid #dfe6e9; border-radius: 12px; text-align: center; 
            background: #fdfdfd; transition: 0.3s; box-sizing: border-box;
        }
        input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 4px rgba(230, 126, 34, 0.1); }

        .btn-start { 
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white; padding: 16px; width: 100%; border: none; 
            border-radius: 12px; font-size: 1.2rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(230, 126, 34, 0.3); transition: transform 0.2s;
        }
        .btn-start:active { transform: scale(0.98); }
        .btn-start:disabled { background: #b2bec3; cursor: not-allowed; box-shadow: none; }

        #status { margin-top: 20px; font-size: 1rem; color: #636e72; min-height: 24px; }
        .tracking-on { color: #27ae60; font-weight: bold; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* ëŒ€ì‹œë³´ë“œ ìœ„ì ¯ ìŠ¤íƒ€ì¼ */
        .widget-box {
            background: var(--primary); color: white; padding: 25px; 
            border-radius: 20px; margin-bottom: 15px; text-align: center;
            box-shadow: var(--shadow);
        }
        .widget-label { font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .widget-value { font-size: 3rem; font-weight: 800; font-variant-numeric: tabular-nums; line-height: 1.2; }
        .widget-sub { font-size: 0.85rem; opacity: 0.7; margin-top: 5px; }

        /* [ì¶”ê°€] ì»¤ìŠ¤í…€ ì•Œë¦¼/ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .toast-message {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 25px;
            font-size: 1rem; z-index: 4000; opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .toast-message.show { opacity: 1; }

        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 5000;
        }
        .custom-modal-box {
            background: white; padding: 25px; border-radius: 15px; width: 300px;
            text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .custom-modal-text { margin-bottom: 20px; font-size: 1.1rem; word-break: keep-all; }
        .custom-modal-btns { display: flex; gap: 10px; justify-content: center; }
        .custom-modal-btn {
            flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
        }
        .btn-alert-ok { background: #3498db; color: white; width: 100%; }

        /* [ì¶”ê°€] ì¹´ìš´íŠ¸ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
        .countdown-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none;
            justify-content: center; align-items: center; z-index: 6000;
        }
        #countdownNumber {
            font-size: 15rem; color: #f1c40f; font-weight: bold;
            font-variant-numeric: tabular-nums;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1 id="raceTitle">ğŸƒ ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ</h1>
        
        <div class="notice-banner">
            <strong>âš ï¸ ìë™ ê³¨ì¸ ì‹œìŠ¤í…œ ì•ˆë‚´</strong><br>
            1. <strong>ê³µì‹ ê¸°ë¡ ìš°ì„ :</strong> GPX ê¸°ë¡ì€ ë³´ì™„ìš©ì´ë©°, ìµœì¢… ìˆœìœ„ëŠ” ì‹¬íŒì˜ ìˆ˜ë™ ê¸°ë¡ì´ ìš°ì„ í•©ë‹ˆë‹¤.<br>
            2. <strong>í™œì„±í™” ì¡°ê±´:</strong> ì¶œë°œ í›„ <strong>30ë¶„ ê²½ê³¼ ì‹œ</strong> ì‘ë™í•©ë‹ˆë‹¤.<br>
            3. <strong>ì¸ì‹ ë²”ìœ„:</strong> ê³¨ì¸ ì§€ì  <strong>ë°˜ê²½ <span class="radius-val">20</span>m ì´ë‚´</strong> ì§„ì… ì‹œ ìë™ ê°ì§€.<br>
            4. <strong>ì£¼ì˜:</strong> ì •í™•í•œ ì¸¡ì •ì„ ìœ„í•´ <strong>í™”ë©´ì„ ë„ì§€ ë§ˆì„¸ìš”.</strong>
        </div>

        <div class="card">
            <h2>ğŸ ì„ ìˆ˜ ë“±ë¡ ë° ì¶”ì </h2>
            <div id="statusMessage" style="margin-bottom: 20px; font-size: 0.95rem; color: #34495e; background: #ecf0f1; padding: 15px; border-radius: 10px; line-height:1.5;">
                ë°°ë²ˆì„ ì…ë ¥í•˜ê³  <strong>[ìœ„ì¹˜ ì¶”ì  ì‹œì‘]</strong>ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.<br>
                <span style="font-size:0.85rem; color:#7f8c8d;">(ì¶œë°œ 30ë¶„ í›„ë¶€í„° ê³¨ì¸ ì§€ì  <span class="radius-val">20</span>m ì ‘ê·¼ ì‹œ ìë™ ì™„ë£Œ)</span>
            </div>

            <input type="number" id="bibNumber" placeholder="ë°°ë²ˆ (ì˜ˆ: 101)" inputmode="numeric">
            
            <button class="btn-start" id="startBtn" onclick="startTracking()">ğŸ“¡ ìœ„ì¹˜ ì¶”ì  ì‹œì‘</button>
            
            <div style="margin-top: 15px; font-size: 0.8rem; color: #95a5a6;">
                * ë²„íŠ¼ í´ë¦­ ì‹œ ìœ„ì¹˜ ì •ë³´ ìˆ˜ì§‘ì— ë™ì˜í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
            </div>
            
            <div id="status">ì—°ê²° ëŒ€ê¸° ì¤‘...</div>
        </div>
  
        <div id="timerBox" class="widget-box" style="display:none;">
            <div class="widget-label">RACE TIME</div>
            <div id="timerDisplay" class="widget-value">00:00:00</div>
        </div>

        <div id="distanceDisplay" class="widget-box" style="display:none; background: #34495e;">
            <div class="widget-label">DISTANCE TO FINISH</div>
            <div class="widget-value" style="color:#f1c40f;"><span id="distNum">--</span>m</div>
            <div class="widget-sub">(<span class="radius-val">20</span>m ì´ë‚´ ì§„ì… ì‹œ ìë™ ê³¨ì¸)</div>
        </div>
    </div>

    <!-- ì»¤ìŠ¤í…€ ì•Œë¦¼/ëª¨ë‹¬ ìš”ì†Œ -->
    <div id="toastMessage" class="toast-message">ì•Œë¦¼</div>

    <div id="alertModal" class="custom-modal-overlay">
        <div class="custom-modal-box">
            <div id="alertText" class="custom-modal-text">ì•Œë¦¼</div>
            <div class="custom-modal-btns">
                <button class="custom-modal-btn btn-alert-ok" onclick="closeAlert()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="countdownOverlay" class="countdown-overlay">
        <div id="countdownNumber">5</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let watchId = null;
        let raceStartTime = null;
        let raceFinishTime = null;
        let timerInterval = null;
        let currentRadius = 20; // ê¸°ë³¸ê°’

                // [ìë™ ì„¤ì •] í˜„ì¬ ì—°ë„ ì ìš©
        const currentYear = new Date().getFullYear();
        document.title = `${currentYear} ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ - ìë™ê³¨ì¸`;
        document.getElementById('raceTitle').innerText = `ğŸƒ ${currentYear} ë¶€ì²œíŠ¸ë¼ì´ ì‚°ì•…ë§ˆë¼í†¤ëŒ€íšŒ - ìë™ê³¨ì¸`;

        // [ì¶”ê°€] ì»¤ìŠ¤í…€ UI í—¬í¼ í•¨ìˆ˜ë“¤
        function showToast(msg) {
            const el = document.getElementById('toastMessage');
            el.innerText = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 2000);
        }

        let alertCallback = null;
        function showAlert(msg, onOk) {
            document.getElementById('alertText').innerText = msg;
            document.getElementById('alertModal').style.display = 'flex';
            alertCallback = onOk;
        }
        function closeAlert() {
            document.getElementById('alertModal').style.display = 'none';
            if(alertCallback) alertCallback();
            alertCallback = null;
        }

        function startTracking() {
            const bib = document.getElementById('bibNumber').value;
            if(!bib) {
                return showToast("ë°°ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”!");
            }

            if (navigator.geolocation) {
                // ì •í™•ë„ ë†’ì€ ìœ„ì¹˜ ì¶”ì  ì˜µì…˜
                const options = {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 10000
                };

                watchId = navigator.geolocation.watchPosition((pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    
                    document.getElementById('status').innerHTML = 
                        `<div class="tracking-on">ğŸ“ ìœ„ì¹˜ ì¶”ì  ê°€ë™ ì¤‘</div>
                         <div style="font-size: 0.8rem; margin-top: 5px;">í™”ë©´ì„ ë„ì§€ ë§ê³  íœ´ëŒ€í•´ ì£¼ì„¸ìš”.</div>`;
                    
                    socket.emit('player_location', { 
                        bibNumber: bib, 
                        lat: lat, 
                        lng: lng 
                    });
                }, (err) => {
                    showAlert("GPS ìˆ˜ì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.");
                }, options);
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('startBtn').innerText = "ì¶”ì  ì¤‘ (ê³µì‹ ê¸°ë¡ ëŒ€ê¸°)";
            } else {
                showAlert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì¶”ì ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        }

        socket.on('auto_goal_success', (data) => {
            showAlert(`[ê°ì§€ ì„±ê³µ] ${data.name}ë‹˜, ê³¨ì¸ ì§€ì  í†µê³¼ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ìµœì¢… ìˆœìœ„ëŠ” ì‹¬íŒ íŒì • í›„ í™•ì •ë©ë‹ˆë‹¤.`, () => {
                location.href = "/"; 
            });
        });

        socket.on('distance_update', (data) => {
            const distBox = document.getElementById('distanceDisplay');
            const distNum = document.getElementById('distNum');
            distBox.style.display = 'block';
            distNum.innerText = data.distance;

            // ê±°ë¦¬ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€í™” (ê°€ê¹Œì›Œì§€ë©´ ì´ˆë¡ìƒ‰)
            if(data.distance <= currentRadius) {
                distNum.style.color = "#2ecc71";
            } else {
                distNum.style.color = "#f1c40f";
            }
        });

        // [ì„¤ì •] ì´ˆê¸° ì„¤ì •ê°’ ìˆ˜ì‹ 
        socket.on('current_settings', (data) => {
            if(data.goalRadius) {
                currentRadius = data.goalRadius;
                updateRadiusUI(currentRadius);
            }
        });

        socket.on('radius_changed', (val) => {
            currentRadius = val;
            updateRadiusUI(val);
        });

        function updateRadiusUI(val) {
            document.querySelectorAll('.radius-val').forEach(el => {
                el.innerText = val;
            });
        }

        // [íƒ€ì´ë¨¸] ëŒ€íšŒ ìƒíƒœ ìˆ˜ì‹ 
        socket.on('race_status', (data) => {
            if (data.isStarted) {
                document.getElementById('countdownOverlay').style.display = 'none';
                raceStartTime = new Date(data.startTime);
                raceFinishTime = data.finishTime ? new Date(data.finishTime) : null;
                document.getElementById('timerBox').style.display = 'block';

                if (data.isFinished) {
                    document.querySelector('#timerBox div:first-child').innerText = "ëŒ€íšŒê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
                    updateTimer();
                    return;
                }

                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(updateTimer, 1000);
                updateTimer();
            }
        });

        // [ì¶”ê°€] ì„œë²„ë¡œë¶€í„° ì¹´ìš´íŠ¸ë‹¤ìš´ ìˆ˜ì‹ 
        socket.on('countdown', (count) => {
            const overlay = document.getElementById('countdownOverlay');
            const num = document.getElementById('countdownNumber');
            
            if (count > 0) {
                overlay.style.display = 'flex';
                num.innerText = count;
            } else {
                overlay.style.display = 'none';
            }
        });

        function updateTimer() {
            if (!raceStartTime) return;
            const now = raceFinishTime ? raceFinishTime : new Date();
            const diff = now - raceStartTime;
            
            const h = Math.floor(diff / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('timerDisplay').innerText = 
                `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }
    </script>
</body>
</html>