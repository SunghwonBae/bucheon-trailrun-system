<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì•„ì´ë“¤ ì‹œê°„ íƒí—˜ëŒ€</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --bg-color: #f0f9ff; --border-bold: 2px solid #3498db; --border-dot: 1px dashed #bdc3c7; }
        body { font-family: 'Jua', sans-serif; background: var(--bg-color); margin: 0; padding: 20px; }
        
        /* ì—„ë§ˆì˜ Todo ì°½ê³  */
        .todo-storage { 
            background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 0 #ddd;
            display: flex; gap: 10px; margin-bottom: 30px; border: 3px solid #3498db;
        }
        .todo-item { 
            padding: 10px 20px; border-radius: 15px; cursor: grab; font-weight: bold;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1); transition: transform 0.2s;
        }
        .todo-item:active { cursor: grabbing; transform: translateY(4px); }

        /* ì´í‹€ì¹˜ ì»¨í…Œì´ë„ˆ */
        .days-container { display: flex; gap: 20px; overflow-x: auto; }
        .day-column { flex: 1; min-width: 400px; background: white; border-radius: 20px; padding: 15px; }
        
        /* ì‹œê°„í‘œ í…Œì´ë¸” */
        .schedule-table { width: 100%; border-collapse: collapse; }
        .time-row { height: 50px; }
        .time-row.on-hour { border-top: var(--border-bold); } /* ì •ì‹œ ì‹¤ì„  */
        .time-row.half-hour { border-top: var(--border-dot); } /* 30ë¶„ ì ì„  */
        
        .time-label { width: 60px; text-align: center; font-size: 0.9rem; color: #7f8c8d; }
        .child-slot { width: 30%; border-left: 1px solid #eee; position: relative; }
        .slot-inner { min-height: 40px; display: flex; flex-wrap: wrap; gap: 4px; padding: 5px; }
        
        .child-header { text-align: center; font-size: 1.2rem; padding: 10px 0; background: #3498db; color: white; border-radius: 10px 10px 0 0; }
        
        .nav-btns { margin-bottom: 10px; display: flex; justify-content: space-between; }
        button { padding: 10px 20px; border-radius: 30px; border: none; background: #e67e22; color: white; cursor: pointer; font-size: 1rem; }

        /* ìƒë‹¨ í—¤ë” */
        .header-section { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .btn-add-todo { background: #6c5ce7; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #4834d4; transition: 0.2s; }
        .btn-add-todo:active { transform: translateY(4px); box-shadow: none; }

        /* ëª¨ë‹¬ì°½(íŒì—…) ìŠ¤íƒ€ì¼ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border: 4px solid #a29bfe; }
        .input-group { margin: 15px 0; text-align: left; }
        .input-group input[type="text"] { width: 90%; padding: 10px; border: 2px solid #dfe6e9; border-radius: 10px; font-size: 1rem; }

        /* ìƒ‰ìƒ ì„ íƒê¸° */
        .color-options { display: flex; gap: 10px; margin-top: 5px; justify-content: center; }
        .color-circle { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: 0.2s; }
        .color-circle:hover { transform: scale(1.2); }
        .color-circle.selected { border-color: #2d3436; transform: scale(1.1); }
        .modal-btns { display: flex; justify-content: space-around; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="header-section">
        <h2>ğŸ’ í•  ì¼ ë³´ë¬¼ì°½ê³ </h2>
        <button onclick="openModal()" class="btn-add-todo">â• ìƒˆ í• ì¼ ë§Œë“¤ê¸°</button>
    </div>

    <div class="todo-storage" id="masterTodos">
        <div style="color:#aaa; padding:10px;">ë¡œë”© ì¤‘...</div>
    </div>

    <div id="todoModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>âœ¨ ìƒˆë¡œìš´ í€˜ìŠ¤íŠ¸ ë§Œë“¤ê¸°</h3>
            <div class="input-group">
                <label>ì´ë¦„:</label>
                <input type="text" id="newTodoTitle" placeholder="ì˜ˆ: ë…ì„œ, í”¼ì•„ë…¸, ì¤„ë„˜ê¸°">
            </div>
            <div class="input-group">
                <label>ìƒ‰ìƒ:</label>
                <div class="color-options">
                    <div class="color-circle selected" style="background:#ff7675" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#74b9ff" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#55efc4" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#fab1a0" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#a29bfe" onclick="selectColor(this)"></div>
                    <div class="color-circle" style="background:#ffeaa7" onclick="selectColor(this)"></div>
                </div>
                <input type="hidden" id="selectedColor" value="#ff7675">
            </div>
            <div class="modal-btns">
                <button onclick="closeModal()" style="background:#95a5a6">ì·¨ì†Œ</button>
                <button onclick="saveNewMaster()" style="background:#00b894">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div class="nav-btns">
        <button onclick="changeDate(-2)">â¬…ï¸ ì´ì „</button>
        <h2 id="dateRange">ë‚ ì§œ ë¡œë”© ì¤‘...</h2>
        <button onclick="changeDate(2)">ë‹¤ìŒ â¡ï¸</button>
    </div>

    <div class="days-container" id="scheduleBoard">
        <div class="day-column">
            <h3 align="center">ì˜¤ëŠ˜ (5ì›” 20ì¼)</h3>
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th></th>
                        <th class="child-header" style="background:#ff9f43">í•˜ëŒ</th>
                        <th class="child-header" style="background:#54a0ff">ì›€ì°¬</th>
                        <th class="child-header" style="background:#5f27cd">íƒœë‘</th>
                    </tr>
                </thead>
                <tbody id="timeGrid">
                    </tbody>
            </table>
        </div>
        </div>

<script>
    const API_BASE = '/api/todo'; // ë¼ìš°í„° ê²½ë¡œ

    // =========================================
    // 1. ì´ˆê¸°í™” ë° ë‚ ì§œ ê´€ë ¨ (ì¼ë‹¨ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¸íŒ…)
    // =========================================
    let currentDate = new Date(); // í˜„ì¬ ë³´ê³  ìˆëŠ” ê¸°ì¤€ ë‚ ì§œ

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', () => {
        updateDateDisplay();
        loadMasters(); // ì—„ë§ˆì˜ í•  ì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        initGrid();    // ì‹œê°„í‘œ í‹€ ë§Œë“¤ê¸° (ê»ë°ê¸°)
    });

    function updateDateDisplay() {
        // ë‚ ì§œ í¬ë§·íŒ… (ì˜ˆ: 5ì›” 20ì¼)
        const options = { month: 'long', day: 'numeric' };
        const startStr = currentDate.toLocaleDateString('ko-KR', options);
        
        // ë‚´ì¼ ë‚ ì§œ ê³„ì‚°
        let nextDate = new Date(currentDate);
        nextDate.setDate(currentDate.getDate() + 1);
        const endStr = nextDate.toLocaleDateString('ko-KR', options);

        document.getElementById('dateRange').innerText = `${startStr} - ${endStr}`;
    }

    // ë‚ ì§œ ì´ë™ (ì‘ë™í•˜ë„ë¡ ìˆ˜ì •ë¨)
    function changeDate(days) {
        currentDate.setDate(currentDate.getDate() + days);
        updateDateDisplay();
        // TODO: ë‚˜ì¤‘ì— ì—¬ê¸°ì„œ loadPlans()ë¥¼ í˜¸ì¶œí•´ ì¼ì •ì„ ìƒˆë¡œê³ ì¹¨ í•´ì•¼ í•¨
    }


    // =========================================
    // 2. ì—„ë§ˆì˜ í•  ì¼(Master Todo) ê¸°ëŠ¥
    // =========================================

    // ì„œë²„ì—ì„œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    async function loadMasters() {
        try {
            const res = await fetch(`${API_BASE}/masters`);
            const masters = await res.json();
            
            const container = document.getElementById('masterTodos');
            container.innerHTML = ''; // ì´ˆê¸°í™”

            masters.forEach(m => {
                const div = document.createElement('div');
                div.className = 'todo-item';
                div.style.background = m.color;
                div.innerText = m.title;
                div.dataset.id = m.id; // ë“œë˜ê·¸í•  ë•Œ ì‹ë³„ì
                container.appendChild(div);
            });

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì¬ì—°ê²°
            new Sortable(container, {
                group: { name: 'shared', pull: 'clone', put: false }, // ë³µì œ ëª¨ë“œ
                sort: false,
                animation: 150
            });

        } catch (err) {
            console.error("í•  ì¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", err);
            document.getElementById('masterTodos').innerHTML = "ì„œë²„ ì—°ê²° ì‹¤íŒ¨ ğŸ˜¢";
        }
    }

    // ìƒˆ í•  ì¼ ì €ì¥í•˜ê¸° (ì„œë²„ë¡œ ì „ì†¡)
    async function saveNewMaster() {
        const title = document.getElementById('newTodoTitle').value;
        const color = document.getElementById('selectedColor').value;

        if (!title) {
            alert("í•  ì¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/masters`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, color })
            });

            if (res.ok) {
                closeModal();
                loadMasters(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                document.getElementById('newTodoTitle').value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
            } else {
                alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        } catch (err) {
            console.error(err);
        }
    }


    // =========================================
    // 3. UI í—¬í¼ í•¨ìˆ˜ë“¤ (ëª¨ë‹¬, ê·¸ë¦¬ë“œ ë“±)
    // =========================================

    function openModal() { document.getElementById('todoModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('todoModal').style.display = 'none'; }
    
    // ìƒ‰ìƒ ì„ íƒ ì‹œ í…Œë‘ë¦¬ íš¨ê³¼
    function selectColor(el) {
        document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        // rgb -> hex ë³€í™˜ ë˜ëŠ” ë°°ê²½ìƒ‰ ê·¸ëŒ€ë¡œ ê°’ìœ¼ë¡œ ì‚¬ìš©
        // ì—¬ê¸°ì„  í¸ì˜ìƒ elementì˜ style.background ê°’ì„ ê°€ì ¸ê°‘ë‹ˆë‹¤.
        // í•˜ì§€ë§Œ backgroundê°’ì´ rgb(...)ë¡œ ì¡í ìˆ˜ ìˆìœ¼ë¯€ë¡œ, 
        // ê°„ë‹¨í•˜ê²Œ ë¯¸ë¦¬ ì§€ì •ëœ hexê°’ì„ dataì†ì„±ìœ¼ë¡œ ë‘ëŠ”ê²Œ ì¢‹ì§€ë§Œ, 
        // ì§€ê¸ˆì€ ì§ê´€ì ì¸ rgbê°’ë„ DB ì €ì¥ì— ë¬¸ì œ ì—†ìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.
        document.getElementById('selectedColor').value = el.style.backgroundColor; 
    }

    // ì‹œê°„í‘œ ê·¸ë¦¬ë“œ ê·¸ë¦¬ê¸° (ê¸°ì¡´ ì½”ë“œ ìœ ì§€í•˜ë˜, ì•½ê°„ ë‹¤ë“¬ìŒ)
    function initGrid() {
        const gridContainer = document.getElementById('scheduleBoard');
        gridContainer.innerHTML = ''; // ì´ˆê¸°í™”

        // ì˜¤ëŠ˜, ë‚´ì¼ 2ì¼ì¹˜ ìƒì„±
        [0, 1].forEach(dayOffset => {
            let d = new Date(currentDate);
            d.setDate(d.getDate() + dayOffset);
            const dateStr = d.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' });

            // HTML ë¬¸ìì—´ ìƒì„±
            let tableHTML = `
                <div class="day-column">
                    <h3 align="center">${dateStr}</h3>
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th class="child-header" style="background:#ff9f43">í•˜ëŒ</th>
                                <th class="child-header" style="background:#54a0ff">ì›€ì°¬</th>
                                <th class="child-header" style="background:#5f27cd">íƒœë‘</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // 08:00 ~ 22:00 ë£¨í”„
            for(let h=8; h<=22; h++) {
                ['00', '30'].forEach(m => {
                    if(h===22 && m==='30') return;
                    const isHour = (m === '00');
                    const timeLabel = `${String(h).padStart(2,'0')}:${m}`;
                    
                    tableHTML += `
                        <tr class="time-row ${isHour ? 'on-hour' : 'half-hour'}">
                            <td class="time-label">${isHour ? timeLabel : ''}</td>
                            <td class="child-slot" data-child="í•˜ëŒ" data-time="${timeLabel}">
                                <div class="slot-inner"></div>
                            </td>
                            <td class="child-slot" data-child="ì›€ì°¬" data-time="${timeLabel}">
                                <div class="slot-inner"></div>
                            </td>
                            <td class="child-slot" data-child="íƒœë‘" data-time="${timeLabel}">
                                <div class="slot-inner"></div>
                            </td>
                        </tr>
                    `;
                });
            }

            tableHTML += `</tbody></table></div>`;
            gridContainer.insertAdjacentHTML('beforeend', tableHTML);
        });
    }
</script>
</body>
</html>